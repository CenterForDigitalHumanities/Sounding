<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <meta charset="utf-8">
        <!-- If these are uncommented, it causes conflicts on the home page.  The module on the home page needs to run by itself, and this needs to be its own page. -->
        <link rel="stylesheet" href="../brokenBooks/css/brokenbooks.css">	
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>  
        <script src="../brokenBooks/js/bb.js"></script>  
        <title>Sort Breviary Order</title>
        <style>
            .leafPopover{
                position: absolute;
                display: none;
                left: 0;
                right: 0;
                margin: 0 auto;
                top: 25px;
            }
            .mainBlock{
                background-color:white;
            }
            .mainBlock.imgAdditionArea{
                background-color:black !important;
            }
            p{
                color: black;
            }
            .rangeArrangementArea{ /* Force each area to be the same height in this case. */
                height: 512px;
                z-index: 2;
            }
            .arrangeSection{
                z-index: 2;
            }
            .arrangeSection div{
                z-index: 1;
            }
            div[leaf="true"]{
                display: block;
                border: 2px solid black;
            }
            .child .child{
                display: none;
            }
            .parent .child{
                display: none;
            }
            .unassigned .child{ /* This will hide leaves sitting in the unassigned areas. */
                display: none !important;
            }
            .unassigned .parent{ /* This will hide leaves sitting in the unassigned areas. */
                display: none !important;
            }
            .arrangeSection, .unassigned{
                padding: 13px 50px 13px 21px !important
            }
            .notBucket{
                padding: 4px 4px 45px 4px;
                border: 1px solid red;
                margin-bottom: 5px;
            }
            div[relation="bucket"] {
                display: inline-block;
                border-right: 2px solid black;
                border-left: transparent;
                border-top: transparent;
                border-bottom: transparent;
            }  
            #mainBlockHelp{
                display: none;
                position: fixed;
                margin: 0 auto;
                
            }
            #mainBlockHelp h4{
                margin: 5px 10px !important;
                text-align: left !important;
                color: #6D6E7B;
                font-family: sans-serif;
                font-size: 14px;
                font-weight: bold;
            }
            #mainBlockHelp p{
                padding: 0px !important;
                text-align: left !important;
                margin: 0px 10px !important;
                color: #6D6E7B;
                font-family: sans-serif;
                font-size: 14px;
            }
            #mainBlockHelp .demoContent{
                padding: 5px 0px;
                
            }
            .leafPopover{
                z-index: 6;
            }
            /*.rectoImg, .versoImg{
                background-image : url("http://165.134.241.141/brokenBooks/images/imgNotFound.png") !important;
            } */    
            
            
            .demoContent{
                background-color: white;
                border: 2px solid #6D6E7B;
                font-family: sans-serif;
            }
            .popHdr{
                color:white;
                position: absolute;
                top: 10px;
                font-weight: bold;
                font-size: 22px;
                font-family: sans-serif;
                text-transform: uppercase;
                left: 50px;
            }
            .demoPopover input[type="button"]{
                padding: 2px 20px;
                display: block;
                background-color: #791C2D !important;
                width: 275px;
                font-size: 20px;
                font-weight: bold;
                font-family: sans-serif;
                margin: 10px auto;
            }
            .demoPopover{
                position: fixed;
                left: 0px;
                right: 0px;
                margin: 0px auto;
                top: 5%;
                background-color: #000;
                padding: 37px 45px;
                display: none;
                width: 497px;
                z-index: 5;
                overflow-y : auto;
                max-height: 85%;
            }
            
            #gotoMirador{
                padding: 3px 0px;
                display: inline-block;
                background-color: #791C2D !important;
                width: auto;
                font-size: 16px;
                font-weight: bold;
                font-family: sans-serif;
                text-align: center;
                color: white;
                left: 0;
                position: relative;
                margin-left: 164px;
                cursor: pointer;
            }
            .ui-sortable-helper{
                display: block;
                position: relative;
                text-align: center;
                padding: 8px 32px 8px 21px;
                border: 2px solid black;
                width: auto;
            }
        </style>
    </head>
    <body>
        <img onclick="$('#mainBlockHelp').show(); $('.mainBlockCover').show();"
        class="helperIcon" src="http://165.134.241.141/brokenBooks/images/redinfo1.png" />
        <input id="gotoMirador" class="helperIcon" onclick="" value="View In Mirador" />
        <div class="mainBlock">
            <div class="mainBlockCover"></div>
            <div class="arrangeTrail adminTrail">
                <div class="rangeArrangementArea" depth = "1" rangeID="bucket">
                   <div class="rAreaLabel">Llangantock Subsections</div>
                   
                   <div ondragover='dragOverHelp(event);' ondrop='dropHelp(event);' class="notBucket"></div>
                   <div ondragover='dragOverHelp(event);' ondrop='dropHelp(event);' rangeID="bucket" onclick='toggleChildren($(this), "admin", event);'  class="arrangeSection parent unassigned sortOrder"><span>BUCKET</span></div>
                   <input class="makeGroup" value="Group" type="button" onclick="askForNewTitle($(this).parent());"/>
                   <input class="addGroup" value="Add" type="button" onclick="newGroupForm($(this).parent());"/>
                   <input class="makeSortable" value="Sort" type="button" onclick="makeSortable($(this).parent());"/><input class="doneSortable" value="Done" type="button" onclick="stopSorting($(this).parent());"/><br>
                   <input class="resetCounts" value="Reset Folio Count" type="button" onclick="resetFolioCount();"/>
                </div>
            </div>
        </div>
        <div id="mainBlockHelp" class="demoPopover"> 
                <div class="leafPopClose" onclick="$('#mainBlockHelp').hide(); $(this).parent().parent().find('.mainBlockCover').hide();">X</div>
                <div class="popHdr">Help</div>
                <div class='demoContent'>
                    <p>
                        You cannot add leaves in this interface.
                    </p>
                    <p>
                        You can add a new section/group and place existing leaves within them.
                    </p>
                    <h4>Drag and Drop</h4>
                    <p>
                        When you drag and drop, you are specifically moving one grouping to another.
                        The original positioning will be removed. You can drop into any group and into any
                        column's red area.  When you move a grouping, you also move all of its children with it.
                    </p>
                    <h4>Create New Group</h4>     
                    <p>
                        You can create a new group in any column by clicking the 'Add' button. You will be given a list of leaves to add
                        to the area and a field to enter a label. You can make an empty group.
                        You can also group any existing groups or leaves together. Check their checkboxes
                        and click 'Group' to group the select areas together. Leaves grouped in the
                        unassigned areas will be removed from unassigned and ordered within the red
                        area.
                    </p>
                    <h4>Remove Group</h4>
                    <p>
                        If you want to remove a group, you can "break" it. Removing a group would mean
                        you also want to remove all of its children. Breaking a group removes the parent
                        and brings up all the children. If you break a leaf or an empty group, you delete it.
                        Right click on an area to be given the option to break it.
                    </p>
                    <h4>Order a Group</h4>
                    <p>
                        If you would like to order a group, click to expand its children to a column and click
                        the Sort button. You will not be able to do any dragging or area creation while you
                        are ordering a group. Either cancel or save to resume blocked functionality.
                    </p>
                    <h4>Bucket/Unassigned</h4>
                    <p>
                        Each column has an 'unassigned' area. This area is for leaves that have not been
                        specifically ordered by another group or from being given a position. The leaves in
                        the unassigned area of a group are in no specific order but specifically tied to that group.
                        The unassigned area cannot be ordered. Make a group out of the leaves in these areas or drag them out and drop
                        them where you want them to go.
                    </p>
                    <p>
                        Each listed area can be clicked to reveal its children and unassigned area or to
                        close it.
                    </p>
                    <h4>Leaf Locking (* in development)</h4>
                    <p>
                        Each leaf has a lock icon with pointing up and down.  You can lock a leaf to its sibling by clicking
                        this lock icon.  The icon will appear locked if the leaf has already been locked.  When you lock a leaf,
                        all position reassigning done to one leaf will automatically happen to the other.  This represents leaves you
                        know are consecutive with each other, so if you want to move one to another section, you have to take all the 
                        consecutive locked siblings as well.
                    </p>
                    <h4>Miscellaneous</h4>
                    <p>
                        The number of leaves in an area are shown in a page icon on the right of each
                        group bar. If you have made changes, the leaf count may not be accurate. You can
                        click 'Reset Folio Count' to get an accurate leaf count for each section. It will save
                        all changes and close everything to do this.
                    </p>
                    <p>    
                        Each leaf has a blue 'i' icon.  Click this to open the leaf creation interface with that leaves information
                        already populated.  The leaf metadata can be altered.  
                    </p>
                    <p>Hold Ctrl when clicking on a section or leaf to see a pop-up to change its title.</p>
                    <p>You cannot drop a leaf into the first area...this area is only for groups.</p>
                    <p>You cannot drop into a currently selected section, you cannot drag and drop a currently selected section.</p>
                    <input type="button" onclick="$('#mainBlockHelp').hide(); $('.mainBlockCover').hide();" value="Close" />
                </div>
            </div>
        <div id="newGroupForm">
            <p>Enter a label for the new group, then select the leaves that belong.  They will initially be unordered, you will need to order them.</p>
            Label: <input type="text" id="groupTitle" />
            <div id="allLeaves">

            </div>
            <div class="noTitleWarning">You must supply a label to create a new group!</div>
            <input id="saveGroupForm" type="button" onclick="saveNewGroupForm();" value="Save"/>
            <input type="button" onclick="cancelNewGroupForm();" value="Cancel"/>
        </div>
        <div class="leafPopover"></div>
        
    </body>
    <script>

    function makeSortable(column){
        //Will sortable overrule draggable? 
        var columnDepth = column.attr("depth");
        $.each($(".adminTrail").find(".rangeArrangementArea").not(".rangeArrangementArea[depth='"+columnDepth+"']"), function(){
            var overDiv = $("<div class='areaCover'></div>");
            $(this).append(overDiv);
        });
        column.children(".makeSortable").hide();
        column.children(".doneSortable").show();
        column.children('.notBucket').sortable(
            {
                cursorAt: {
                    left: 50,
                    top: 45
                },
                helper: function (event, item) {
                    // make sure at least one item is selected.

                    if (!item.hasClass("ui-state-active")) {
                        item.addClass("ui-state-active").siblings().removeClass("ui-state-active");
                    }
                    //maybe class it as notBucket?
                    var $helper = $("<div></div>");
                    
                    if(item.find(".lockedUp").length>0){
                        console.log("locked up");
                        var consecutive = item.prev();
                        console.log(consecutive.attr("leaf"));
                        console.log(consecutive.find(".lockedDown").length);
                        while(consecutive.attr("leaf") === "true"){
                            if(consecutive.find(".lockedDown").length > 0){
                                console.log("up add active");
                                consecutive.addClass("ui-state-active");
                                consecutive = consecutive.prev();
                            }
                            else{ //reverse order
//                                for(var i=lockedWith.length-1; i>-1; i--){
//                                    stringToPass1 += lockedWith[i] + ",";
//                                }
                                console.log("end c1");
                                break;
                            }

                        }

                    }
                    if (item.find(".lockedDown").length>0){
                        console.log("locked down");
                        var consecutive2 = item.next();
                        console.log(consecutive2);
                        //stringToPass2 += $("#"+event.target.id).attr("rangeID") +",";
                        while(consecutive2.attr("leaf") === "true"){
                            if(consecutive2.find(".lockedUp").length > 0){
                                console.log("down add active")
                                consecutive2.addClass("ui-state-active");
                                consecutive2 = consecutive2.next();
                            }
                            else{
                                console.log("end c2");
                                break;
                            }
                        }
                    }
                        var $selected = item.parent().children(".ui-state-active");
                        console.log("SELECTED");
                        console.log($selected);
                        var $cloned = $selected.clone();
                        console.log("CLONED");
                        console.log($cloned);
                        $helper.append($cloned);
                        // hide it, don't remove!
                        $selected.hide();
                        // save the selected items
                        item.data("multi-sortable", $cloned);
                        console.log("Return");
                        console.log($helper);
                        return $helper;
                    
                    
                },

                stop: function (event, ui) {
                    // add the cloned ones
                    console.log("stop");
                    console.log(ui.item);
                    var $cloned = ui.item.data("multi-sortable");
                    ui.item.removeData("multi-sortable");
                    console.log($cloned);
                    // append it
                    if(ui.item.next().find(".lockedUp") > 0){
                        console.log("Dropping inbetween a lock1");
                        //How should we handle this?
                    }
                    else if(ui.item.prev().find(".lockedDown") > 0){
                        console.log("Dropping inbetween a lock2");
                        //How should we handle this?
                    }
                    else{
                        console.log("allowed sort");
                        ui.item.after($cloned);
                    }
                    
                    // remove the hidden ones
                    ui.item.siblings(":hidden").remove();

                    // remove self, it's duplicated
                    ui.item.remove();
                }
                    
            });
        
    }
    function stopSorting(column){
        var windowurl = document.location.href;
        var children = column.children(".notBucket").children(".arrangeSection");
        var childrenArray = [];
        if(windowurl.indexOf("demo=1") >-1){
            column.children(".notBucket").sortable("destroy");
            $(".areaCover").remove();
            column.children(".makeSortable").show();
            column.children(".doneSortable").hide();
        }
        else{
            $.each(children, function(){
                childrenArray.push($(this).attr("rangeID"));
            });
            console.log("update "+column.attr("rangeID") +"with ordered array");
            console.log(childrenArray);
        //need to update this column range id with the new order of ranges
            var updateURL ="http://165.134.241.141/brokenBooks/updateRange"; //update list with the range removed
            var paramObj1 = {"@id" : column.attr("rangeID"), "ranges" : childrenArray};
            var params1 = {"content" : JSON.stringify(paramObj1)};
            $.post(updateURL, params1, function(){
               column.children(".notBucket").sortable("destroy");
               $(".areaCover").remove();
               column.children(".makeSortable").show();
               column.children(".doneSortable").hide();
            });
        }
        
    }
    function resetFolioCount(){
        if($(".rangeArrangementArea:first").find(".selectedSection").length > 0){
            $(".rangeArrangementArea:first").find(".selectedSection").click();
        }
        //wait for click event to resolve
        setTimeout(function(){
            $.each($(".arrangeSection"), function(){
                $(this).children(".folioCount").remove();
                var folioCount = $(this).find("div[leaf='true']").length;
                var folioCountHTML = $("<span class='folioCount'>"+folioCount+"</span>");
                if($(this).attr("leaf") === "true"){
                    folioCountHTML = $("<span class='folioCount'><img class='leafIcon' src='http://165.134.241.141/brokenBooks/images/leaf.png'/></span>");
                }      
                $(this).append(folioCountHTML);
            });
        },500);
    }

        $(function(){
            //NOTE: THIS SHOULD ONLY WORK FOR ADMINS
            var windowURL = document.location.href;
            if(windowURL.indexOf("LFD") > -1){
                $("#gotoMirador").attr("onclick", "document.location.href='http://165.134.241.141/brokenBooks/getManifest.html?LFD';");
            }
            else if(windowURL.indexOf("DTC")){
                $("#gotoMirador").attr("onclick", "document.location.href='http://165.134.241.141/brokenBooks/getManifest.html?DTC';");
            }
            else if(windowURL.indexOf("demo=1")>-1){
                $("#gotoMirador").attr("onclick", "document.location.href='http://165.134.241.141/brokenBooks/demoManifest.html';");
            }
            else{
                $("#gotoMirador").attr("onclick", "document.location.href='http://165.134.241.141/brokenBooks/getManifest.html';");
            }
            if(windowURL.indexOf("home.html") < 0){
                $(".leafPopover").load("../brokenBooks/leafPopover.html", function(){
                    $(".leaf").load("../brokenBooks/leafInformation.html", function(){
                            console.log("SET TABS");
                            $("#formTabs").tabs({
                                activate: function(event ,ui){
                                //console.log(event);
                                if(ui.newTab.index() === 4){ //check for the selection of the arrante tab to change the side bar
                                    $(".sideBarInfo").hide();
                                    $("#sideBarArrange").show();
                                }
                                else{
                                    $(".sideBarInfo").show();
                                    $("#sideBarArrange").hide();
                                }
                            }
                            });
                            $('.canvasImageFile').on("change", function(event){
                                var target = event.target;
                                var rv = $(this).attr("rv"); //This is so we know whether it was the recto or verso one.  
                                var files = !!this.files ? this.files : [];
                                var canvasURI = $(this).parent().parent().attr("canvas"); //local
                                if (!files.length || !window.FileReader) return 0; // no file selected, or no FileReader support

                                if (/^image/.test( files[0].type)){ // only image file
                                        var filename = files[0].name; //get the file name so we can pass it through the interfact for the user if we want.
                                    var reader = new FileReader(); // instance of the FileReader
                                    reader.readAsDataURL(files[0]); // read the local file
                                    reader.onloadend = function(){ // set image data as background of div
                                        $("."+rv+"Img").attr("src", this.result).show("explode", "500ms");
                                        $("."+rv+"Img").css("background-image", "none");
                                        $("."+rv+"Canvas").find(".imgCatalogueInfo").show("explode", "500ms");
                                        $("textarea[rv='"+rv+"']").html(filename +" Uploaded!").attr("disabled", "disabled");
                                         var annotationObject = {
                                            "format":"image/jpg",
                                            "@type":"dctypes:Image",
                                            "resource":
                                            {
                                                "@id": this.result,
                                                "service":
                                                    {                                       
                                                        "@context": "http://iiif.io/api/image/2/context.json",
                                                        "profile":"http://iiif.io/api/image/2/profiles/level2.json",
                                                        "@id" : this.result
                                                    },
                                                "width": 667, //how should I set these?
                                                "height":1000 //how should I set these?
                                            },
                                            "on" : canvasURI
                                        };
                                                        //$("#catalogueInfoFor").val(canvasURI);
                                        //(annotationObject, canvasURI); // local
                                        addImage(annotationObject, canvasURI); // live\
                                        target.parentNode.childNodes[1].onclick=""; //Take the onclick away that fires upload image.
                                        target.parentNode.ondblclick=function(){ //Now it has to be double clicked to fire upload image. 
                                            target.click();
                                        };
                                    };
                                }
                            });
                            //gatherRangesForArrange(1); //populate the popover.  It cannot be altered on this page, so do not populate it.
                            $("#folioSide1").attr("onclick","enterCatalogueInfo('http://www.example.org/iiif/LlangBrev/canvases/demo1', 'recto');"); //local
                            $("#folioSide1").attr("canvas","http://www.example.org/iiif/LlangBrev/canvases/demo1"); //local
                            $("#folioSide2").attr("onclick","enterCatalogueInfo('http://www.example.org/iiif/LlangBrev/canvases/demo2', 'verso');"); //local
                            $("#folioSide2").attr("canvas","http://www.example.org/iiif/LlangBrev/canvases/demo2"); //local
                            $("#folioSide1").click();
                        });
                });
            }
            gatherRangesForArrange(2); //populate the admin interface
        });
        

    </script>
</html>
