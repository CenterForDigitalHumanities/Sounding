<!DOCTYPE html>
<html>
	<head>
            <meta charset="utf-8">
            <link rel="stylesheet" href="../brokenBooks/css/brokenbooks.css">	
            <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>  
            <script src="http://localhost:8080/brokenBooks/js/bb.js"></script>  
            
            <title>Breviary Leaf Addition</title>
            <style>
            .rangeArrangementArea{
                display: inline-table;
            }
            </style>
	</head>
	<body>
            <div class="mainBlock intro">
                    <p>
                            Here you can create a leaf.  Once you are finished and the information is submitted it will be reviewed for accuracy.  If your data is accurate, your leaf will be placed with the other LLangantock Breviary leaves. 
                    </p>
                    <p>You will prepare this leaf as <span id="whoCreates">a contriubter</span></p>

                    <!-- TESTED. SUCCESSFUL.  
                    <div id="serverLogin">
                            <iframe id="serverLoginFrame" src="http://localhost/image_console.php" WIDTH=650 HEIGHT=400 >
                                            TEST TEST TEST
                            </iframe>
                    </div> -->

                    <input type="button" id="beginLeafCreation" value="Begin Preparing A Leaf" onclick="submitIntro();"/>
                    <input type="button" id="editLeaf" value="View Existing Leaf" onclick="existing();"/>
                    <input id="beAdmin" type="button" value="Be Project Admin" onclick="admin();"/>
                    <input id="beContributer" type="button" value="Be A Contributer" onclick="contributer();"/>
            </div>
            <div class="leafPopover"></div>
					
	</body>
</html>
<script>
var admin = false;
var contributer = true;
function existing(leaf, leafIsIn){
        var alphaCanvas = "http://165.134.241.141/annotationstore/annotation/554ce6d0e4b0f1c678d2a545";
        var betaCanvas = "http://165.134.241.141/annotationstore/annotation/554ce6d0e4b0f1c678d2a547";
        //var leaf = "http://165.134.241.141/annotationstore/annotation/554ce6d0e4b0f1c678d2a549";
        
    if(leaf !== undefined){
        var leafObject = undefined;
        currentLeafServerID = leaf;
        $.each(testManifest.structures, function(){
            //For the demo, you can cheat and not make the calls by making a mock list above and using it.  
            if(this["@id"] == leaf){
                leafObject = this;
                alphaCanvas = this.canvases[0];
                betaCanvas = this.canvases[1];
                var alphaAnnoList = alphaCanvas.otherContent;
                $.ajax({
                    "url":alphaAnnoList,
                    success: function(annoList1){
                        annoList1 = JSON.parse(annoList1);
                        annoListCollection[0] = annoList1;
                    }
                }); //live
                var betaAnnoList = betaCanvas.otherContent;
                $.ajax({
                    "url":betaAnnoList,
                    success: function(annoList2){
                        annoList2 = JSON.parse(annoList2);
                        annoListCollection[1] = annoList2;
                    }
                });//live
                var leafAnnoList = this.otherContent; //anno list URIS
                $.ajax({
                    "url":leafAnnoList,
                    success: function(annoList3){
                        annoList3 = JSON.parse(annoList3);
                        annoListCollection[2] = annoList3;
                    }
                });//live
            }
        });       
    }
    else{ //for the tester from the creation intro set of buttons. 
        leafIsIn = "http://www.example.org/iiif/LlangBrev/range/8";
        leaf = "http://165.134.241.141/annotationstore/annotation/554ce6d0e4b0f1c678d2a549";
        currentLeafServerID = leaf;
    }
    $("#folioSide1").attr("onclick","enterCatalogueInfo('"+alphaCanvas+"', 'recto');"); 
    $("#folioSide1").attr("canvas", alphaCanvas);
    $("#folioSide1").addClass("selectedFolio");
    $("#folioSide2").attr("onclick","enterCatalogueInfo('"+betaCanvas+"', 'verso');"); 
    $("#folioSide2").attr("canvas", betaCanvas);   
    $("#oneAndtwo").attr("canvas", leaf);
    $("#oneAndtwo").attr("onclick","enterCatalogueInfo('leaf');"); 
    $(".leafPopover").show();
    $("#mainBlockCover").show();
    submitIntro('testEdit');
    alpha = true;
    $("#folioSide1").click();
    selectInTree(leafIsIn);
}

function selectInTree(child){
    var depth = $(".rangeArrangementArea").length;
    var lastArrangeArea = $('.rangeArrangementArea[depth="'+depth+'"]');
    var childToFindParents = lastArrangeArea.find(".arrangeSection[rangeID='"+child+"']");
    var theParent = childToFindParents.parent();
    var control = true;
    console.log("Does range exist? :"+childToFindParents.length);
    console.log("IS IT THE UNASSIGNED? : "+childToFindParents.attr("class").indexOf("unassigned"));
    if(childToFindParents.length === 0 || childToFindParents.attr("class").indexOf("unassigned") > -1){
        return false;
    }
    console.log("Check the parents.  First Class: "+theParent.attr("class"));
    if(theParent.attr("class").indexOf("notBucket") > -1 || theParent.attr("class").indexOf('unassigned') > -1 ){
        childToFindParents.click();
        selectInTree(child);
        // childToFindParents.addClass('selectedSection');
        // toggleChildren(childToFindParents, "recurse");
    }
    else{
        while(control == true){
            console.log("In while.  Class: "+theParent.attr("class"));
            if(theParent.attr("class").indexOf("notBucket") > -1 || theParent.attr("class").indexOf('unassigned') > -1 ){
                control = false;
            }
            else{
                if(theParent.parent().attr("class") == "notBucket" || theParent.parent().attr("class").indexOf('unassigned') > -1 ){
                    //do nothing
                    console.log("control is false");
                    control = false;
                }
                else{
                    console.log("parent parent");
                    theParent = theParent.parent();
                }
            }
        }
        recurseID = child;
        theParent.click();
        selectInTree(child);
        // theParent.addClass('selectedSection');
        // toggleChildren(theParent, "recurse");
    }

}

//Below is a typical starter object from a project manager creating the manifest and the ancho leaf in that manifest.  This anchor leaf only had one canvas, which I assume we are allowing as a worse case scenario so I am accounting for it that way.  
var alphaAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/1", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : ""
};
var betaAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/2", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : ""
};
var zetaAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/3", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : ""
};
var anchorAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/4", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : "http://www.example.org/iiif/LlangBrev/canvas/1_anchor"
};
annoListCollection.push(alphaAnnoList, betaAnnoList, zetaAnnoList);


	$(function(){
		$(".leafPopover").load("../brokenBooks/leafPopover.html", function(){
                    $(".leaf").load("../brokenBooks/leafInformation.html", function(){
                        console.log("SET TABS");
                        $("#formTabs").tabs({
                            activate: function(event ,ui){
                            //console.log(event);
                            if(ui.newTab.index() === 4){ //check for the selection of the arrante tab to change the side bar
                                $(".sideBarInfo").hide();
                                $("#sideBarArrange").show();
                            }
                            else{
                                $(".sideBarInfo").show();
                                $("#sideBarArrange").hide();
                            }
                        }
                        });
                        $('.canvasImageFile').on("change", function(event){
                            var target = event.target;
                            var rv = $(this).attr("rv"); //This is so we know whether it was the recto or verso one.  
                            var files = !!this.files ? this.files : [];
                            var canvasURI = $(this).parent().attr("canvas"); //local
                            var canvasServerURI = $(this).parent().parent().find(".imgCatalogueInfo").attr("canvasServerID"); //live
                            if (!files.length || !window.FileReader) return 0; // no file selected, or no FileReader support

                            if (/^image/.test( files[0].type)){ // only image file
                                    var filename = files[0].name; //get the file name so we can pass it through the interfact for the user if we want.
                                var reader = new FileReader(); // instance of the FileReader
                                reader.readAsDataURL(files[0]); // read the local file
                                reader.onloadend = function(){ // set image data as background of div
                                    $("."+rv+"Img").attr("src", this.result).show("explode", "500ms");
                                    $("."+rv+"Canvas").find(".imgCatalogueInfo").show("explode", "500ms");
                                    $("textarea[rv='"+rv+"']").html(filename +" Uploaded!").attr("disabled", "disabled");
                                    var newAnnoURI = "http://www.example.org/iiif/LlangBrev/annos/" +annoID; 
                                    var newImageURI = "http://www.example.org/iiif/LlangBrev/images/" +imageID; 
                                    var annotationObject = {
                                                            "@id" : newAnnoURI,
                                                    "@type" : "oa:Annotation",
                                                    "motivation" : "sc:painting",
                                                    "label" : "Canvas Image",
                                                    "resource" : {
                                                            "@id" : newImageURI,
                                                            "@type" : "dctypes:Image",
                                                            "format" : "image/jpeg",
                                                            "height" : 2365,
                                                            "width" : 1579
                                                            },
                                                            "on" : canvasServerURI
                                                    };
                                                    //$("#catalogueInfoFor").val(canvasURI);
                                    //(annotationObject, canvasURI); // local
                                    addImage(annotationObject, canvasServerURI); // live\
                                    target.parentNode.childNodes[1].onclick=""; //Take the onclick away that fires upload image.
                                    target.parentNode.ondblclick=function(){ //Now it has to be double clicked to fire upload image. 
                                        target.click();
                                    };
                                };
                            }
                        });
                    });
                });
	});
		
</script>
