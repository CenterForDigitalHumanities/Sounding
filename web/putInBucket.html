<!DOCTYPE html>
<html>
	<head>
            <meta charset="utf-8">
            <link rel="stylesheet" href="../brokenBooks/css/brokenbooks.css">	
            <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
            <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>  
            
            <title>Breviary Leaf Addition</title>
	</head>
	<body>
		<div class="mainBlock intro">
			<p>
				Here you can create a leaf.  Once you are finished and the information is submitted it will be reviewed for accuracy.  If your data is accurate, your leaf will be placed with the other LLangantock Breviary leaves. 
			</p>
			<p>You will prepare this leaf as <span id="whoCreates">a contriubter</span></p>

			<!-- TESTED. SUCCESSFUL.  
			<div id="serverLogin">
				<iframe id="serverLoginFrame" src="http://localhost/image_console.php" WIDTH=650 HEIGHT=400 >
						TEST TEST TEST
				</iframe>
			</div> -->
			
			<input type="button" id="beginLeafCreation" value="Begin Preparing A Leaf" onclick="submitIntro();"/>
 			<input id="beAdmin" type="button" value="Be Project Admin" onclick="admin();"/>
			<input id="beContributer" type="button" value="Be A Contributer" onclick="contributer();"/>
		</div>
		<div class="mainBlock imgAdditionArea">
			<div id="leafAdditionLabel">
				Llangantock Leaf Addition
			</div>
            <div class="sideBarInfo">
                <div id="whatPiece">
                    <div id="oneAndtwo">
                    	<div id="oneAndtwoLabel">LEAF LABEL</div><img style="display:none;" class="rectoImg" src=""/><img style="display:none;" class="versoImg" src=""/>
                   	 	<i>EYE</i>
                	</div>
                    <div id="folioSide1"><input type="file" rv="recto" class="canvasImageFile" required="true" multiple="false" />
                    	<div id="folio1Label">Folio 1 Label</div>
                    	<img onclick="$(this).parent().find('input[type=\'file\']').click();" class="rectoImg" src=""/>
                    	<i>EYE</i>
                	</div>
                    <div id="folioSide2"><input type="file" rv="verso" class="canvasImageFile" required="true" multiple="false" />
                    	<div id="folio1Label">Folio 2 Label</div>
                    	<img onclick="$(this).parent().find('input[type=\'file\']').click();" class="versoImg" src=""/>
						<i>EYE</i>
                    </div>
                </div>
            </div>
            <div class="leaf"></div>
            <div style="clear:both"></div>
        </div>				
	</body>
</html>
<script>

//Here we have the "binder" to add our pieces into.  Notice that right now I have defined an anchor object and the master sequence range.
var rangeID = 1;
var canvasID = 1;
var annoID = 1;
var imageID = 1;
var annoListID = 5;
var currentLeaf = "";
var alpha, beta, zeta = false;
var annoListCollection = [];
var serverCanvasID = -1;
var serverAnnoID = -1;
var currentLeafServerID = -1;
var admin = false;
var contributer = true;

//Below is a typical starter object from a project manager creating the manifest and the ancho leaf in that manifest.  This anchor leaf only had one canvas, which I assume we are allowing as a worse case scenario so I am accounting for it that way.  
var alphaAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/1", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : ""
}
var betaAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/2", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : ""
}
var zetaAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/3", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : ""
}
var anchorAnnoList = {
	"@id":"http://www.example.org/iiif/LlangBrev/annoList/4", 
	"@type":"sc:AnnotationList",
	"resources" : [],
	"on" : "http://www.example.org/iiif/LlangBrev/canvas/1_anchor"
}
annoListCollection.push(alphaAnnoList, betaAnnoList, zetaAnnoList);
var testManifest = {
	  "@context" : "http://iiif.io/api/presentation/2/context.json",
	  "@id" : "",
	  "@type" : "sc:Manifest",
	  "label" : "Llang Binder",
	  "sequences" : [{
	  	"@id" : "http://www.example.org/iiif/LlangBrev/sequence/normal",
	    "@type" : "sc:Sequence",
	    "label" : "Llangantock Bucket",
	    "canvases" : [{
	    //This will be the anchor canvas in the anchor range
	        "@id" : "http://www.example.org/iiif/LlangBrev/canvas/1_anchor",
	        "@type" : "sc:Canvas",
	        "label" : "Llang_001",
	        "height" : 1000,
	        "width" : 667,
	        "images" : [{
		          "@type" : "oa:Annotation",
		          "motivation" : "sc:painting",
		          "resource" : {
		            "@id" : "http://www.example.org/iiif/LlangBrev/image_001",
		            "@type" : "dctypes:Image",
		            "format" : "image/jpeg",
		            "height" : 2365,
		            "width" : 1579
		          },
		          "on" : "http://www.example.org/iiif/LlangBrev/canvas/1_anchor"
        	}],
        	"otherContent":[],
      	 }]
   	   }], 
	  "structures" : [
	  	{
 		  "@id":"http://www.example.org/iiif/LlangBrev/range/master",
	      "@type":"sc:Range",
	      "label":"Llangantock Breviary Page Order",
	      "ranges" : [
	          //add leaf ranges here in order for page order
	      ],
	      "canvases" :[],
	      "resources" : [], //NOT IIIF COMPLIANT
	      "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
		},
		
		{
 		  "@id":"http://www.example.org/iiif/LlangBrev/range/anchor",
	      "@type":"sc:Range",
	      "label":"Llangantock Breviary Anchor",
	      "ranges" : [
	      ],
	      "canvases" :["http://www.example.org/iiif/LlangBrev/canvas/1_anchor"],
	      "resources" : [], //NOT IIIF COMPLIANT
	      "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
		}
	  ]
}

	function addImage(anno, canvasURI){
		//DO not add image annotations into an annotation list. 
		//console.log("CANVASURI: "+canvasURI);
		//console.log(anno);
		//here, the anno is an image annotation.  The object can be directly saved into a canvases 'images[]' field outside of an annotation list.  I have the @id of the canvas and the annotation I want to put into its images[] field.
		//createNewAnno(anno); //live
		//anno["@id"] = annoServerID; //live
		$.each(testManifest.sequences[0].canvases, function(){
			if(this["@id"] === canvasURI){
				this.images.push(anno);
				imageID++;
				//updateCanvas
				return false;
			}
		})
	}

	/*
		Check if this particular annotation already exists.  If it does, we want to update the annotation.  Otherwise, we want to save a new one.
		@see createNewAnno()
	*/
	function annoExists(annoObject){
		var labelToCheckFor = annoObject.label;
		var tmpAnnos = [];
		var theReturn = false;
		var theURI = "";
		if(zeta){
            tmpAnnos = annoListCollection[2];
		}
		else if(alpha){
            tmpAnnos = annoListCollection[0];
		}
		else{
            tmpAnnos = annoListCollection[1];
		}
		$.each(tmpAnnos.resources, function(){
            if(this.label == labelToCheckFor){
	            theReturn = true;
	            return -1;
            }
		});
		return theReturn;
	}

	function updateAnnotation(annoURI, annoObj){
		console.log("Update Anno, don't save new one.")
		var resourceObj = annoObj.resource;
		var updateAnnoURL = "http://localhost:8080/brokenBooks/updateRange";
		var paramObj = {"@id":annoURI, "resource": resourceObj};
		var params = {"content":JSON.stringify(paramObj)};
		$.post(updateAnnoURL, params, function(data){
			console.log("Anno updated on server");
		});
		if(zeta){
            $.each(annoListCollection[2].resources, function(){
                if(this["@id"] == annoURI){
                        this.resource = annoObj.resource;
                        console.log("Local Anno Updated.");
                }
            });
		}
		else if (alpha){
            $.each(annoListCollection[0].resources, function(){
                if(this["@id"] == annoURI){
                        this.resource = annoObj.resource;
                        console.log("Local Anno Updated.");
                }
            });
		}
		else{
            $.each(annoListCollection[1].resources, function(){
                if(this["@id"] == annoURI){
                        this.resource = annoObj.resource;
                        console.log("Local Anno Updated.");
                }
            });
		}
	}

	/*
		This function takes the annotation object and saves it in the manifest object in the appropriate location.  it makes the decision whether the annotation is being saved to a canvas or a range. 
	*/
	function createNewAnno(annoObject, newLabel, value, list){
		// A.K.A update annotationList
		annoID ++;
		var objectID = $("#catalogueInfoFor").val(); //which object are we saving to
		var annoServerID = -1;
		console.log("Create new anno for "+objectID);
		annoObject.on = objectID; //set the on property to be what object we are saving to 
		var newAnnoUrl = "http://localhost:8080/brokenBooks/saveNewRange";
		var params = {'content':JSON.stringify(annoObject)};
		var labelToCheckFor = annoObject.label;
		var tmpAnnos = [];
		var theReturn = undefined;
		var theURI = "";

		/* See if the annotation exists and if so, update the annotation isntead of saving a new one. */
		if(zeta){
			tmpAnnos = annoListCollection[2];
		}
		else if(alpha){
			tmpAnnos = annoListCollection[0];
		}
		else{
			tmpAnnos = annoListCollection[1];
		}
		$.each(tmpAnnos.resources, function(){
			if(this.label == labelToCheckFor){
				updateAnnotation(this["@id"], annoObject);
			}
		});
		if(annoExists(annoObject)){ /* Works with the code block above this.  Check if this annotation exists and if so, we do not want to run any of the code below.  */
			return false;
		}
		$.post(newAnnoUrl, params, function(data){
			data=JSON.parse(data);
			annoObject["@id"] = data["@id"];
			list.append("<li><span class='formLabel'>"+newLabel+" </span> "+value+"<span annoServerID='"+data["@id"]+"' onclick='removeInfo($(this));' class='removeInfo'> X </span></li>");
			if(zeta){
				annoListCollection[2].resources.push(annoObject); //live
				console.log("Leaf list is updated");
			}
			else if(alpha){
				annoListCollection[0].resources.push(annoObject); //live
				console.log("Alpha list is updated");
			}
			else{
				annoListCollection[1].resources.push(annoObject); //live
				console.log("Beta list is updated")
			}

			console.log("Starting update of list collection on server")
			$.each(annoListCollection, function(){
				if (this.on === objectID){ //this is our annotation list to add the annotation to 
					this.resources.push(annoObject); //push the annotation to the appropriate list.
					// console.log("ANNO ADDED TO THIS LIST "+objectID);
					// console.log(annoObject);
					//Image annotation vs. line annotation?
					var updateAnnoListURL = "http://localhost:8080/brokenBooks/updateRange";
					var newResources = this.resources;
					var updateContent = newResources;
					// console.log("anno list");
					// console.log(this);
					// console.log(this["@id"]);
					var paramsObj = {"@id": this["@id"], "resources":JSON.stringify(updateContent)};
					var params = {"content":JSON.stringify(paramsObj)};
					
					$.post(updateAnnoListURL, params, function(data){
						console.log("List Updated On Server");
					});
				}
			}); 
				
		});  //live. 
		 
		if(zeta){
			$.each(testManifest.structures, function(){
				if (this["@id"] === objectID){ //this is our canvas object
					var otherContent1 = {"@id":annoListCollection[2]["@id"], "@type":"sc:AnnotationList"};
					var listIncluded = false;
					$.each(this.otherContent,function(){
						if(this["@id"] === annoListCollection[2]["@id"]){
							listIncluded = true;
							return false;
						}
					})
					if(!listIncluded)this.otherContent.push(otherContent1); //If the annotation list is not already included in the otherContent field, add it. 
					console.log("Local Leaf otherContent updated.");
				}
			});//local. adds the annotation list uri to the other content field.  
		}
		else{
			var annoListID = -1;
			$.each(testManifest.sequences[0].canvases, function(){
				if (this["@id"] === objectID){ //this is our canvas object
					if(alpha){
						annoListID = annoListCollection[0]["@id"];
					}
					else{
						annoListID = annoListCollection[1]["@id"];
					}
					var otherContent2 = {"@id":annoListID, "@type":"sc:AnnotationList"};
					var listIncluded = false;
					$.each(this.otherContent,function(){
						if(this["@id"] === annoListID){
							listIncluded = true;
							return false;
						}
					})
					if(!listIncluded)this.otherContent.push(otherContent2); //If the annotation list is not already included in the otherContent field, add it. 
					console.log("local canvas otherContent updated");
				}
			});
		}//local
	}

	/*
		Add the range object to the structures array in the manifest object. 
	*/
	function createNewRange(newRangeObject, current, newLabel, value, list){
		rangeID ++;
		//create a new range, given that some new information organizes canvases into a new range.  We will need to make sure the range does not already exist. 
		//testManifest.structures.push(newRangeObject); //local
		var newAnnoUrl = "http://localhost:8080/brokenBooks/saveNewRange";
		var rangeServerID = -1;
		$.post(newAnnoUrl, {'content': JSON.stringify(newRangeObject)}, function(data){
			data=JSON.parse(data);
			newRangeObject["@id"] = data["@id"]; //live
			testManifest.structures.push(newRangeObject); //live
			if(current === 'currentLeaf'){
				currentLeafServerID = data["@id"];
				annoListCollection[2].on = data["@id"];
				currentLeaf = currentLeafServerID;
                                $("#oneAndtwo").attr("onclick", "enterCatalogueInfo('leaf')");
			}
			else{
				list.append("<li><span class='formLabel'>"+newLabel+" </span> "+value+"<span annoServerID='"+data["@id"]+"' class='removeInfo'> X </span></li>");
			}
			
        	var newRangeAnnoList = {
                //"@id":"http://www.example.org/iiif/LlangBrev/annoList/"+annoListID, 
                "@type":"sc:AnnotationList",
                "resources" : [],
                "on" : data["@id"]
        	}
        	var listURL = "http://localhost:8080/brokenBooks/saveNewRange";
        	var listParams = {"content" : JSON.stringify(newRangeAnnoList)};
        	$.post(listURL, listParams, function(data2){
        		data2 = JSON.parse(data2);
        		console.log("New Anno List 2");
        		console.log(data2);
        		annoListCollection[2]["@id"] = data2["@id"];
        		var updateCanvasURL = "http://localhost:8080/brokenBooks/updateCanvas";
        		var paramObj = {"@id":currentLeafServerID, "otherContent":[data["@id"]]};
        		var params = {"content":JSON.stringify(paramObj)};
        		$.post(updateCanvasURL, params, function(data){
        			console.log("Leaf otherContent updated live");
        		});
        	});
		});
		
	}
	/*
		This range is already in the manifest structures section, so what we are actually trying to do is save this leaf to the already created range.  We must check whether the leaf URI is already in the "ranges" section of the range.  There should be no duplicate URIs. 
	*/
	function updateRange(rangeID, leaf){
		//console.log("Updating range "+rangeID+" with leaf "+leaf);
		var currentRange = {};
		$.each(testManifest.structures, function(){
			if(this["@id"] === rangeID){
				if(!$.inArray(leaf, $(this).ranges)){
					var ranges = this.ranges;
					this.ranges.push(leaf);
					var newAnnoUrl = "http://localhost:8080/brokenBooks/updateRange";
					var paramObj = {"ranges" : ranges};
					var params = {"content" : JSON.stringify(paramObj)};
					$.post(newAnnoUrl, params, function(data){

					});
				}
				else{
					console.log('LEAF already in range.');
					return false;
				}
			}
		});
		//var url = "http://localhost:8080/brokenBooks/updateRangeServlet";
		//I have a new leaf URL to add to a range, so I want to pass the rangeID and leafURL.  
		//$.post(url, newRangeObject);
	}
	
	function resolveImageURI(rv){
		var uri = $("."+rv+"Canvas").find(".uploadness").find('textarea').val();
	    $.ajax({
	        url: uri,
	        success: function(imageData){
	            //console.log(imageData);
	        },
	        error: function(jqXHR,error, errorThrown) {  
	            alert("Image could not be resolved.  Issue: " +  jqXHR.status + " - " +jqXHR.response);
	        }
	    });
	}

	/*
		Dont save the fields and return to the image options.  
	*/

	function cancelFolio(){
		//Don't get data and return to image page
		$(".start").hide("blind", "300ms", function(){
			$(".imgAdditionArea").show("explode", "500ms");
			$("#catalogueInfoFor").val(''); 
			$("#folioSide2").removeClass("selectedFolio");
			$("#folioSide1").removeClass("selectedFolio");
			alpha = beta = zeta = false;
		});
	}

	/*
		Fired when user clicks "Begin preparing a leaf".  We must create the canvases and the leaf range first, then feed it information as necessary. 
	*/
	function submitIntro(){
            $(".intro").hide("blind", "300ms", function(){$(".imgAdditionArea").show("explode", "500ms");});
            var newCanvas1ServerID = -1;
            var newCanvas2ServerID = -1;
            //create a new leaf range and get ID.  The leaf range will create 2 canvases whose ID's I will also need.
            canvasID += 1;
            var newCanvas1 = {
                    "@id" : "http://www.example.org/iiif/LlangBrev/canvas/"+canvasID, //local
                "@type" : "sc:Canvas",
                "label" : "Llang_"+canvasID,
                "height" : 1000,
                "width" : 667,
                "images" : [],
                "otherContent": [annoListCollection[0]["@id"]]
            }
   //    	 var newCanvas1AnnoList = {
			// "@id":"http://www.example.org/iiif/LlangBrev/annoList/"+annoListID, 
			// "@type":"sc:AnnotationList",
			// "resources" : [],
			// "on" : newCanvas1["@id"]
   //      } //local
        //annoListCollection.push(newCanvas1AnnoList);
        annoListID++;
        //testManifest.sequences[0].canvases.push(newCanvas1);
         $("#folioSide1").attr("onclick","enterCatalogueInfo('http://www.example.org/iiif/LlangBrev/canvases/"+canvasID+"', 'recto');"); //local
      	 $("#folioSide1").attr("canvas","http://www.example.org/iiif/LlangBrev/canvases/"+canvasID); //local
      	 //annoListCollection[0].on = "http://www.example.org/iiif/LlangBrev/canvases/"+canvasID; //local
      	 testManifest.sequences[0].canvases.push(newCanvas1); //local
      	 var url = "http://localhost:8080/brokenBooks/saveNewCanvas";
      	 var params1 = {'content': JSON.stringify(newCanvas1)};
      	 $.post(url, params1, function(data){ //save first new canvas
      	 	data = JSON.parse(data);

      	 	newCanvas1["@id"] = data["@id"];
      	 	$("#folioSide1").attr("onclick","enterCatalogueInfo('"+data["@id"]+"', 'recto');"); 
      	 	$("#folioSide1").attr("canvas", data["@id"]); 
      	 	testManifest.sequences[0].canvases.push(newCanvas1); //live
 	   	 	
        	//annoListCollection.push(newCanvas1AnnoList);
        	annoListCollection[0].on = data["@id"];
        	//save anno list for new canvas
        	var newCanvas1AnnoList = {
				//"@id":"http://www.example.org/iiif/LlangBrev/annoList/"+annoListID, 
				"@type":"sc:AnnotationList",
				"resources" : [],
				"on" : data["@id"]
       	 	} //local
        	var listURL1 = "http://localhost:8080/brokenBooks/saveNewRange";
        	var listParams1 = {"content" : JSON.stringify(newCanvas1AnnoList)};
        	$.post(listURL1, listParams1, function(data){ //save first canvas annotation list
        		data = JSON.parse(data);
        		console.log("New Anno List 1");
        		console.log(data);
        		annoListCollection[0]["@id"] = data["@id"];
        		//update otherContent of first canvas
        		var updateCanvasURL = "http://localhost:8080/brokenBooks/updateCanvas";
        		var paramObj = {"@id":newCanvas1["@id"], "otherContent":[data["@id"]]};
        		var params = {"content":JSON.stringify(paramObj)};
        		$.post(updateCanvasURL, params, function(data){
        			console.log("Canvas 1 otherContent updated live");
        		});
        	});
      	 	console.log("FIRST CANVAS SAVED ID "+ data["@id"]);
      	 	newCanvas1ServerID = data["@id"];
  	 		canvasID += 1;
      	 	var newCanvas2 = {
      	 		"@id" : "http://www.example.org/iiif/LlangBrev/canvas/"+canvasID,
		        "@type" : "sc:Canvas",
		        "label" : "Llang_"+canvasID,
		        "height" : 1000,
		        "width" : 667,
		        "images" : [],
		        "otherContent" : [annoListCollection[1]["@id"]]
	      	 }
   	  //    	 	var newCanvas2AnnoList = {
	  //               "@id":"http://www.example.org/iiif/LlangBrev/annoList/"+annoListID, 
	  //               "@type":"sc:AnnotationList",
	  //               "resources" : [],
	  //               "on" : newCanvas2["@id"]
	  //       }
			// annoListCollection.push(newCanvas2AnnoList);
			//local
			annoListID++;
                $("#folioSide2").attr("onclick","enterCatalogueInfo('http://www.example.org/iiif/LlangBrev/canvases/"+canvasID+"','verso');");
      	 	$("#folioSide2").attr("canvas","http://www.example.org/iiif/LlangBrev/canvases/"+canvasID);
      	 	//testManifest.sequences[0].canvases.push(newCanvas2); //local
	      	//annoListCollection[1].on = "http://www.example.org/iiif/LlangBrev/canvases/"+canvasID; //local
	      	var params2 = {'content': JSON.stringify(newCanvas2)};
	      	$.post(url, params2, function(data){
	      		data=JSON.parse(data);
	      		console.log("Second CANVAS SAVED ID "+ data["@id"]);
	      		newCanvas2ServerID = data["@id"];
      	 		newCanvas2["@id"] = data["@id"];
      	 		$("#folioSide2").attr("onclick","enterCatalogueInfo('"+data["@id"]+"','verso');");
      	 		$("#folioSide2").attr("canvas", data["@id"]);
      	 		testManifest.sequences[0].canvases.push(newCanvas2); //live
 		   	 	var newCanvas2AnnoList = {
	                //"@id":"http://www.example.org/iiif/LlangBrev/annoList/"+annoListID, 
	                "@type":"sc:AnnotationList",
	                "resources" : [],
	                "on" : data["@id"]
	        	}
				var listURL2 = "http://localhost:8080/brokenBooks/saveNewRange";
	        	var listParams2 = {"content" : JSON.stringify(newCanvas2AnnoList)};
	        	annoListCollection[1].on = data["@id"];
	        	$.post(listURL2, listParams2, function(data){
	        		data = JSON.parse(data);
	        		console.log("New Anno List 2");
	        		console.log(data);
	        		annoListCollection[1]["@id"] = data["@id"];
	        		var updateCanvasURL = "http://localhost:8080/brokenBooks/updateCanvas";
	        		var paramObj = {"@id":newCanvas2["@id"], "otherContent":[data["@id"]]};
	        		var params = {"content":JSON.stringify(paramObj)};
	        		$.post(updateCanvasURL, params, function(data){
	        			console.log("Canvas 2 otherContent updated live");
	        		});
	        	});
	  	 	 	rangeID += 1;
	  	 	 	annoListID += 1;
	            var leafRangeObject = {
	            	"@id" : "http://www.example.org/iiif/LlangBrev/range/"+rangeID,
			      	"@type":"sc:Range",
			      	"label":"Llangantock Breviary Page_"+rangeID ,
			      	"canvases" : [
			          //newCanvas1["@id"], //local
			          //newCanvas2["@id"] //local
			          newCanvas1ServerID, //live on dev server
			          newCanvas2ServerID //live on dev server
			      	],
			      	"resources" : [],
			      	"ranges" : [],
		      		"isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal",
		      		"otherContent" : [annoListCollection[2]["@id"]]
        		}
				currentLeaf = "http://www.example.org/iiif/LlangBrev/range/"+rangeID; //local
				console.log("SAVE LEAF");
                                
				createNewRange(leafRangeObject, 'currentLeaf', "", "", "");
      	 	});
  	 	});
      	     	
	}

	function removeInfo(listItem){
		var serverID = listItem.attr("annoserverid");
		var url = "http://localhost:8080/brokenBooks/deleteAnnotationByAtIDServlet";
		var paramObj = {"@id" : serverID};
		var params = {"content" : JSON.stringify(paramObj)};
		$.post(url, params, function(data){
			listItem.remove();
		});
	}

	function admin(){
		admin=true; contributer=false;
		$("#whoCreates").html("the project admin.");
		$("#beAdmin").hide();
		$("#beContributer").show();
	}

	function contributer(){
		admin=false; contributer=true;
		$("#whoCreates").html("a contributer.");
		$("#beAdmin").show();
		$("#beContributer").hide();
	}
        
        function updateImageAnno(which){
            if(which === "alpha"){
                    var updateCanvasURL = "http://localhost:8080/brokenBooks/updateCanvas";
                    var paramObj = {"@id": $("#folioSide1").attr("canvas"), "images":[$('textarea[rv="recto"]').val()]};
                    var params = {"content":JSON.stringify(paramObj)};
                    $.post(updateCanvasURL, params, function(data){
                    });
            }
            else{
                    var updateCanvasURL = "http://localhost:8080/brokenBooks/updateCanvas";
                    var paramObj = {"@id": $("#folioSide2").attr("canvas"), "images":[$('textarea[rv="verso"]').val()]};
                    var params = {"content":JSON.stringify(paramObj)};
                    $.post(updateCanvasURL, params, function(data){
                    });
            }
        }


	$(function(){
		//$(".leaf").load("../brokenBooks/leafTemplate.html"); //This will not exist anymore. 
		$(".leaf").load("../brokenBooks/leafInformation.html", function(){
                    console.log("SET TABS");
                    $("#formTabs").tabs();
                });
                $('.canvasImageFile').on("change", function(event){
                    //start spinny?
                    var target = event.target;
                    var rv = $(this).attr("rv"); //This is so we know whether it was the recto or verso one.  
                    var files = !!this.files ? this.files : [];
                    var canvasURI = $(this).parent().attr("canvas"); //local
                    var canvasServerURI = $(this).parent().parent().find(".imgCatalogueInfo").attr("canvasServerID"); //live
                    if (!files.length || !window.FileReader) return 0; // no file selected, or no FileReader support

                    if (/^image/.test( files[0].type)){ // only image file
                            var filename = files[0].name; //get the file name so we can pass it through the interfact for the user if we want.
                        var reader = new FileReader(); // instance of the FileReader
                        reader.readAsDataURL(files[0]); // read the local file
                        reader.onloadend = function(){ // set image data as background of div
                            $("."+rv+"Img").attr("src", this.result).show("explode", "500ms");
                            $("."+rv+"Canvas").find(".imgCatalogueInfo").show("explode", "500ms");
                            $("textarea[rv='"+rv+"']").html(filename +" Uploaded!").attr("disabled", "disabled");
                            var newAnnoURI = "http://www.example.org/iiif/LlangBrev/annos/" +annoID; 
                            var newImageURI = "http://www.example.org/iiif/LlangBrev/images/" +imageID; 
                            var annotationObject = {
                                                    "@id" : newAnnoURI,
                                            "@type" : "oa:Annotation",
                                            "motivation" : "sc:painting",
                                            "label" : "Canvas Image",
                                            "resource" : {
                                                    "@id" : newImageURI,
                                                    "@type" : "dctypes:Image",
                                                    "format" : "image/jpeg",
                                                    "height" : 2365,
                                                    "width" : 1579
                                                    },
                                                    "on" : canvasServerURI
                                            };
                                            //$("#catalogueInfoFor").val(canvasURI);
                            //(annotationObject, canvasURI); // local
                            addImage(annotationObject, canvasServerURI); // live\
                            target.parentNode.childNodes[1].onclick=""; //Take the onclick away that fires upload image.
                            target.parentNode.ondblclick=function(){ //Now it has to be double clicked to fire upload image. 
                                target.click();
                            };
                            
                        };

                    }
                });
	});
		
</script>
