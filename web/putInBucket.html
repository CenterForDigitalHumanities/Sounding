<!DOCTYPE html>
<html>
	<head>
	  <meta charset="utf-8">
	  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
      <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.js"></script>
    <!--
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
	  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
	  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
	-->
	  <title>Bucket Example</title>
	  <style>
	    input[type="button"]{
	    	padding:5px;
	    	background-color: white;
	    	border: 1px solid black;
	    	cursor: pointer;
	    	font-family: "Comic Sans MS", cursive, sans-serif;
	    }
	    input[type="button"]:hover{
	    	box-shadow: 0px 0px 13px 1px;
	    }
	  	.mainBlock{
			position: relative;
			box-shadow: 0px 0px 13px 3px;
			margin: 0% 0px 0px 10%;
			padding: 10px;
			text-align: center;
			background-color: #545454;
			z-index: 2;
			left: 13%;
			width: 73%;
			height: auto;
	  	}
	  	.intro{
	  		display: block;
	  	}
	  	.start{
			display: none;
	  	}
	  	.info{
	  		display: none;
	  	}
	  	p{
	  		font-size: 10pt;
	  		color: black;
	  		margin: 15px 0px;
	  		color: white;
	  		font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif
	  	}
	  	.label{
	  		display: inline-block;
	  		margin-right: 10px;
	  	}
	  	.sbsSquare{
	  		width: 32%;
	  		border: 1px solid black;
	  		display: inline-table;
	  		height: 300px;
	  		padding-top:50px;
	  		margin-bottom: 15px;
	  	}
	  	.sbsSquare p:first-letter{
               text-transform: uppercase;
        }
        .sbsSquare p {
	        font-family: "Adobe Caslon Pro", "Hoefler Text", Georgia, Garamond, Times, serif;
			letter-spacing:0.1em;
			text-align:center;
			text-transform: lowercase;
			line-height: 145%;
			font-size: 14pt;
			font-variant: small-caps;
        	padding: 0px 10px;
	  	}
	  	.sbsSqaure h2{
	  		font-size: 16pt;
        	font-family:Georgia,serif;
			color:#4E443C;
			font-variant: small-caps; text-transform: none; font-weight: 100; margin-bottom: 0;
	  	}
	  	body{
	  		z-index: 1;
	  		background-image: url("../m2/images/BrokenBook01.jpg");
	  		background-repeat: repeat;
	  	}
	  	.hoverBlue:hover{
	  		box-shadow: 0px 0px 13px 3px rgb(0,255,255);
	  	}
	  	.hoverGreen:hover{
	  		box-shadow: 0px 0px 13px 3px rgb(0,204,0);
	  	}
	  	.hoverRed:hover{
	  		box-shadow: 0px 0px 13px 3px rgb(255,0,127);
	  	}
	  	ul{
	  		margin: 10px 0px;
	  	}
	  	li{
	  		list-style-type: none;
	  	}
	  	#contextForm{
	  		border-bottom: 2px solid rgb(0,204,0);
	  		border-right: 2px solid rgb(0,204,0);
	  		border-left: 2px solid rgb(0,204,0);
	  		position: relative;
	  		height: auto;
	  	}
	  	#contentForm{
	  		border-bottom: 2px solid rgb(0,255,255);
	  		border-right: 2px solid  rgb(0,255,255);
	  		border-left: 2px solid  rgb(0,255,255);
	  		position: relative;
	  		height: auto;
	  	}
	  	#carrierForm{
	  		border-bottom: 2px solid rgb(255,0,127);
	  		border-right: 2px solid rgb(255,0,127);
	  		border-left: 2px solid rgb(255,0,127);
	  		position: relative;
	  		height: auto;
	  	}
	  	#notesForm{
	  		border-bottom: 2px solid yellow;
	  		border-right: 2px solid yellow;
	  		border-left: 2px solid yellow;
	  		position: relative;
	  		height: auto;
	  	}
	  	#contextHeader{
	  		color: rgb(0,204,0);
	  		border-top: 1px solid rgb(0,204,0);
	  		border-right: 1px solid rgb(0,204,0);
	  		border-left: 1px solid rgb(0,204,0);
	  		cursor: pointer;
	  	}
	  	#contentHeader{
	  		color: rgb(0,255,255);
	  		border-top: 1px solid  rgb(0,255,255);
	  		border-right: 1px solid  rgb(0,255,255);
	  		border-left: 1px solid  rgb(0,255,255);
	  		cursor: pointer;
	  	}
	  	#carrierHeader{
	  		color: rgb(255,0,127);
	  		border-top: 1px solid rgb(255,0,127);
	  		border-right: 1px solid rgb(255,0,127);
	  		border-left: 1px solid rgb(255,0,127);
	  		cursor: pointer;
	  	}
	  	#notesHeader{
	  		color: yellow;
	  		border-top: 1px solid yellow;
	  		border-right: 1px solid yellow;
	  		border-left: 1px solid yellow;
	  		cursor: pointer;
	  	}
	  	.infoPart{
	  		margin: 10px 0px;
	  	}
	  	#previousOwners{
	  		width: 300px;
	  	}
	  	.formLabel{
	  		font-family: "Adobe Caslon Pro", "Hoefler Text", Georgia, Garamond, Times, serif;
			letter-spacing:0.1em;
			text-align:center;
			text-transform: lowercase;
			line-height: 145%;
			font-size: 12pt;
			font-variant: small-caps;
        	padding: 0px 10px;
	  	}
	  	.imgAdditionArea{
	  		position: relative;
	  		display: none;
	  	}
	  	.previewImg{
	  		height: 200px;
	  		width: auto;
	  		position: relative;
	  	}
	  	.start .previewImg, .info .previewImg{
	  		margin-bottom:20px;
	  	}
	  	#sideBarInfo{
			position: fixed;
			left: 0px;
			top:15px;
			height:90%;
			overflow-y: auto;
			padding: 5px;
			width: 20%;
			background-color: #545454;
			padding: 10px;
			box-shadow: 0px 0px 13px 3px;
			z-index: 2;
		}
		#whatPiece{
			position: relative;
			margin-bottom: 35px;
		}
		#folioSide1{
			position: relative;
			display: inline-table;
			height: 150px;
			width: 120px;
			margin-right:25px;
			border: 3px solid black;
		}
		#folioSide2{
			position: relative;
			display: inline-table;
			height: 150px;
			width: 120px;
			border: 3px solid black;
		}
		.addedInformation{
			border: 2px solid white;
			position: relative;
			min-height:50px;
			width: 100%;
			display: none;
		}
		#formAccordion{
			position: relative;
			height: 90%;
			border:2px solid black;
			padding-bottom: 10px;
		}
		.contentList{
			position: relative;
			border: 1px solid  rgb(0,255,255);
			padding-left: 0px;
		}
		.contextList{
			position: relative;
			border: 1px solid rgb(0,204,0);
			padding-left: 0px;
		}
		.carrierList{
			position: relative;
			border: 1px solid rgb(255,0,127);
			padding-left: 0px;
		}
		.addedNotes{
			position: relative;
			border: 1px solid yellow;
		}		
		.ui-accordion-content{
			height: 1px;
			padding: 5px 0px;
		}
		.ui-accordion-header{
			padding: 5px 0px;
		}
		*:focus{
			outline: none;
		}
		.ui-state-active{
			outline: none;
		}
		#serverLogin{
			position: relative;
			border: 1px solid black;
		}
		#serverLoginFrame{
			position: relative;
		}
		.selectedFolio{
			border: 3px solid yellow !important;
		}
	  </style>
	</head>
	<body>
		<div class="mainBlock intro">
			<p>
				Here you can create a leaf to place into the bucket.   Login below to begin making a leaf.
				
			</p>

			<!-- TESTED. SUCCESSFUL.  
			<div id="serverLogin">
				<iframe id="serverLoginFrame" src="http://localhost/image_console.php" WIDTH=650 HEIGHT=400 >
						TEST TEST TEST
				</iframe>
			</div> -->
			
			<input type="button" id="beginLeafCreation" value="Begin Preparing A Leaf" onclick="submitIntro();"/>
		</div>

		<div class="mainBlock imgAdditionArea">
			<div class="leaf"></div>
		</div>

		<div class="mainBlock start">
			<!-- <img class="imgPreview" src="" /><br>-->
 			<input type="hidden" id="catalogueInfoFor" value="" />
 			<p>
 				Here is where you can enter addition information about a leaf. Click below to expand and enter information about the fields you have information on. <u style="color: rgb(0,204,0);">Context</u> is about the history of the leaf such as where it has been, who has owned it, etc. <u style="color: rgb(255,0,127);">Carrier</u> information is physical information about the leaf itself, such as support, number of lines, dimensions, etc. <u style="color: rgb(0,255,255);">Content</u> is about the written text on the leaf or page such as the language, author, or a particular part of the text.  
				<u style="color:yellow;">General Metadata</u> is for information you prefer not to assign to any metadata form.  It is better to answer a question in the forms than give general information. 
			</p>
			<div id="formAccordion">
				<h3 id="contextHeader">Context</h3>
				<div id="contextForm">
					<p> Please include information about context here.  If you do not wish to specify your responses, please use the 'other' field.</p>
					<ul>
						<li><span class="formLabel">Shelfmark: </span> <input type="text" class="contextFormEntry" id="contextFolioID"/></li>
						<li><span class="formLabel">Nickname:  </span> <input type="text" class="contextFormEntry" id="nickname" /> </li>
						<li><span class="formLabel">Patron (first owner): </span> <input type="text" class="contextFormEntry" id="contextPatron"/></li>
						<li><span class="formLabel">Former Owners Seperated by Semi-colon (;) </span> <textarea class="contextFormEntry" id="previousOwners"/></textarea></li>
						<li><span class="formLabel">Insignia (coat of arms, etc.) </span> <input type="text" class="contextFormEntry" id="insignia"/></li>
						<li><span class="formLabel">Sales: </span> <input type="text" class="contextFormEntry" id="contextAuction"/></textarea</li>
						<li><span class="formLabel">Date Acquired: </span> <input type="text" class="contextFormEntry" id="contextDateAcquired"/></li>
						<li><span class="formLabel">Exlibris: </span> <input type="text" class="contextFormEntry" id="exlibris"/></li>
						<li><span class="formLabel">Binding: </span> <input type="text" class="contextFormEntry" id="binding"/></li>
						<li><span class="formLabel">Frame or Mat: </span> <input type="text" class="contextFormEntry" id="frame"/></li>
						<!--<li><span class="formLabel">Related Manuscripts by Collection: </span> <input type="text" class="contextFormEntry" id="contextRelated"/></li> -->
						<li><span class="formLabel">Other: </span> <textarea class="contextFormEntry" id="contextOther"></textarea></li>
					</ul>
				</div>
				<h3 id="carrierHeader">Carrier</h3>
				<div id="carrierForm">
					<p> Please include information about carrier here.  If you do not wish to specify your responses, please use the 'other' field.</p>
					<ul>
					<ul>
						<li><span class="formLabel">Date: </span> <input type="text" class="carrierFormEntry" id="carrierDate"/></li>
						<li><span class="formLabel">Place Of Origin: </span> <input type="text" class="carrierFormEntry" id="carrierOrigin"/></li>
						<li><span class="formLabel">Format (single leaf, half bifolium, fragment): </span> <input type="text" class="carrierFormEntry" id="carrierFormat"/></li>
						<li><span class="formLabel">Material Support: </span> <input type="text" class="carrierFormEntry" id="support"/></li>
						<li><span class="formLabel">Dimensions: </span> <span>Width:</span><input type="text" class="carrierFormEntry" id="pageWidth"/><span>Height:<input type="text" class="carrierFormEntry" id="pageHeight"/></span></li>
						<li><span class="formLabel">Condition: </span> <input type="text" class="carrierFormEntry" id="condition"/></li>
						<!-- Do a split for lines and columns like you did for heght and width -->
						<li><span class="formLabel">Layout (lines, columns): </span> <input type="text" id="carrierLayout" class="carrierFormEntry"/> </li>
						<!-- the next two could also be on the same line -->
						<li><span class="formLabel">Rulings: </span> <input type="text" id="carrierRulings" class="carrierFormEntry"/> </li>
						<li><span class="formLabel">Prickings: </span> <input type="text" id="carrierPrickings" class="carrierFormEntry"/> </li>
						<li><span class="formLabel">Script: </span> <input type="text" class="carrierFormEntry" id="carrierScript"/></li>
						<li><span class="formLabel">Music Notation: </span> <input type="text" class="carrierFormEntry" id="musicNotation"/></li>
						<li><span class="formLabel">Scribe (who wrote the script): </span> <input type="text" class="carrierFormEntry" id="scribe"/></li>
						<li><span class="formLabel">Decorations: </span> <input type="text" class="carrierFormEntry" id="carrierDecorations"/></li>
						<li><span class="formLabel">Illustrations: </span> <input type="text" class="carrierFormEntry" id="carrierIllustrations"/></li>
						<li><span class="formLabel">Catch Words: </span> <input type="text" class="carrierFormEntry" id="catchWords"/></li>
						<li><span class="formLabel">Quire Signatures: </span> <input type="text" class="carrierFormEntry" id="carrierSignatures"/></li>
						<li><span class="formLabel">Artist(s)</span> <textarea class="carrierFormEntry" id="carrierArtists"></textarea></li>
						<li><span class="formLabel">Folio Number: </span> <input type="text" class="carrierFormEntry" id="carrierFolioNum"/></li>
						<!--Drop down to pick relation by artist, scribe, workshop -->
						<!--<li><span class="formLabel">Related Manuscripts by Carrier: </span> <input type="text" class="contextFormEntry" id="carrierRelated"/></li>-->
						<li><span class="formLabel">Recto or Verso: </span> <input type="text" class="carrierFormEntry" id="carrierRV"/></li>
						<li><span class="formLabel">Other: </span> <textarea type="text" class="carrierFormEntry" id="carrierOther"></textarea></li>
					</ul>
				</div>
				<h3 id="contentHeader">Content</h3>
				<div id="contentForm">
					<p> Please include information about content here.  If you do not wish to specify your responses, please use the 'other' field.</p>
					<ul>
						<li><span class="formLabel">Language:  </span> <input type="text" id="contentLanguage" class="contentFormEntry" /> </li>
						<li><span class="formLabel">Text Author:  </span> <input type="text" class="contentFormEntry" id="contentAuthor" /> </li>
						<li><span class="formLabel">Generic Title:  </span> <input type="text" class="contentFormEntry" id="contentTitle" /> </li>
						<li><span class="formLabel">Subject:  </span> <input type="text" class="contentFormEntry" id="contentSubject" /> </li>
						<li><span class="formLabel">Structure/Section of Text:  </span> <input type="text" class="contentFormEntry" id="contentSection" /> </li>
						<li><span class="formLabel">Description of Text:  </span> <input type="text" class="contentFormEntry" id="contentDescription" /> </li>
						<li><span class="formLabel">Incipit:  </span> <input type="text" class="contentFormEntry" id="incipit" /> </li>
						<li><span class="formLabel">Explicit:  </span> <input type="text" class="contentFormEntry" id="explicit" /> </li>
						<li><span class="formLabel">Rubrics:  </span> <input type="text" class="contentFormEntry" id="rubrics" /> </li>
						<li><span class="formLabel">Chant:  </span> <input type="text" class="contentFormEntry" id="chant" /> </li>
						<li><span class="formLabel">Gloss:  </span> <input type="text" class="contentFormEntry" id="gloss" /> </li>
						<li><span class="formLabel">Annotations:  </span><span>Marginal:</span><input type="text" class="contentFormEntry" id="marginalAnnos"/><span>Interlinear:<input type="text" class="contentFormEntry" id="interlinearAnnos"/></span> </li>
						<!-- <li><span class="formLabel">Other Transcription :  </span> file upload here </li> -->
						<!-- <li><span class="formLabel">Related Manuscripts by Carrier: </span> <input type="text" class="contextFormEntry" id="contentRelated"/></li> -->
						<li><span class="formLabel">Other: </span> <textarea class="contentFormEntry" id="contentOther"></textarea></li>
					</ul>
				</div>
				<h3 id="notesHeader">General Metadata</h3>
				<div id="notesForm">
					<p> If there are general notes you would prefer not to assign to the metadata forms, you can write those here. </p>
					<textarea class="notesFormEntry" id="notes"></textarea>
				</div>
			</div>
			<input type="button" onclick="saveFolio();" value="Save Metadata"/>
 	        <input type="button" onclick="cancelFolio();" value="Exit Metadata"/>
		</div>
		<div id="sideBarInfo">
			<p>This area will tell you what piece of the leaf you are currently working on.  There are only three options: side ALPHA, side BETA and the leaf as a whole (OMEGA).  You may not know which is recto or verso, so we just call them alpha and beta.  Information you have submitted will also be placed here so you can see your progress.  </p>
			<div id="whatPiece">
				<div id="folioSide1">Side ALPHA</div>
				<div id="folioSide2">Side BETA</div>
			</div>
			<div id="alphaInformation" class="addedInformation">
				<h3>Alpha</h3>
				<ul class="contentList">
				</ul>
				<ul class="contextList">
				</ul>
				<ul class="carrierList">
				</ul>
				<div class="addedNotes"></div>
			</div>
			<div id="betaInformation" class="addedInformation">
				<h3>Beta</h3>
				<ul class="contentList">
				</ul>
				<ul class="contextList">
				</ul>
				<ul class="carrierList">
				</ul>
				<div class="addedNotes"></div>
			</div>
			<div id="zetaInformation" class="addedInformation">
				<h3>OMEGA</h3>
				<ul class="contentList">
				</ul>
				<ul class="contextList">
				</ul>
				<ul class="carrierList">
				</ul>
				<div class="addedNotes"></div>
			</div>
		</div>
	</body>
</html>
<script>

//Here we have the "binder" to add our pieces into.  Notice that right now I have defined an anchor object and the master sequence range.
var rangeID = 1;
var canvasID = 1;
var annoID = 1;
var imageID = 1;
var currentLeaf = "";
var alpha, beta, zeta = false;
//Below is a typical starter object from a project manager creating the manifest and the ancho leaf in that manifest.  This anchor leaf only had one canvas, which I assume we are allowing as a worse case scenario so I am accounting for it that way.  
var testManifest = {
	  "@context" : "http://www.shared-canvas.org/ns/context.json",
	  "@id" : "",
	  "@type" : "sc:Manifest",
	  "label" : "Llang Binder",
	  "sequences" : [{
	  	"@id" : "http://www.example.org/iiif/LlangBrev/sequence/normal",
	    "@type" : "sc:Sequence",
	    "label" : "Llangantock Bucket",
	    "canvases" : [ 
	    //This will be the anchor canvas in the anchor range
	     {
	        "@id" : "http://www.example.org/iiif/LlangBrev/canvas/1_anchor",
	        "@type" : "sc:Canvas",
	        "label" : "Llang_001",
	        "height" : 1000,
	        "width" : 667,
	        "resources" : [ 
	             {
		          "@type" : "oa:Annotation",
		          "motivation" : "sc:painting",
		          "resource" : {
		            "@id" : "http://www.example.org/iiif/LlangBrev/image_001",
		            "@type" : "dctypes:Image",
		            "format" : "image/jpeg",
		            "height" : 2365,
		            "width" : 1579
		          },
		          "on" : "http://www.example.org/iiif/LlangBrev/canvas/anchor"
	        	}
        	]
      	 }
    	 ]
	   }], 
	  "structures" : [
	  	{
 		  "@id":"http://www.example.org/iiif/LlangBrev/range/master",
	      "@type":"sc:Range",
	      "label":"Llangantock Breviary Page Order",
	      "ranges" : [
	          //add leaf ranges here in order for page order
	      ],
	      "canvases" :[],
	      "resources" : [],
	      "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
		},
		
		{
 		  "@id":"http://www.example.org/iiif/LlangBrev/range/anchor",
	      "@type":"sc:Range",
	      "label":"Llangantock Breviary Anchor",
	      "ranges" : [
	      ],
	      "canvases" :["http://www.example.org/iiif/LlangBrev/canvas/1_anchor"],
	      "resources" : [],
	      "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
		}
	  ]
}

/*
	When the form information has been filled out, this function will save annotations to the appropriate canvas or leaf range. Entries that create new ranges will do so, and if that range is already created and needs to be updated, it will do that. It also keeps content, context and carrier information separate from each other so we can track them as such.  
*/

	function saveFolio(){
		var currentLeafObject = {};
		var otherInfo = {};
		var uriToSave = $("#catalogueInfoFor").val() //alpha URI, beta URI, or leaf URI
		var canvasURI = uriToSave;

		//Clear added information for metadta being submitted to avoid duplicates.  The end goal is to have this as a live updater.
		if(zeta){
			$("#zetaInformation").find('ul').empty();
		} 
		else{
			if(alpha) $("#alphaInformation").find('ul').empty();
			if(beta) $("#betaInformation").find('ul').empty();
		}

		$.each(testManifest.structures, function(){
			if ($(this)["@id"] === uriToSave){
				currentLeafObject = $(this); //Set the actual leaf object if the uriToSave is a leaf uri
				return false;
			}
		});
		
		//Go through each content piece, grab its value and if applicable make it an annotation or a range.
		$(".contentFormEntry").each(function(){
			var addedInfoList = {};
			if(zeta){ addedInfoList = $("#zetaInformation").find(".contentList"); }
			else if(alpha){ addedInfoList = $("#alphaInformation").find(".contentList"); }
			else if(beta){ addedInfoList = $("#betaInformation").find(".contentList"); }
			var entryID = $(this).attr("id");
			var entryValue = $(this).val();
			var annotationObject = {
			"@id" : "",
	        "@type" : "oa:Annotation",
	        "motivation" : "sc:painting",
	        "label" : "",
	        "resource" : {
	          "@type" : "cnt:ContentAsText",
	          "cnt:chars" :""
			},
			"on" : canvasURI //this will be a rangeURI if uriToSave is set to the leaf uri instead of a canvasURI, which is what we want.  annotations can be saved to ranges. 
			};
			var rangeObject = { //this will only be saved 
				"@id" : "",
		        "@type" : "sc:Range",
		        "motivation" : "sc:painting",
		        "label" : "",
		        "canvases": [],
		        "ranges" : [currentLeaf], //This is always the URI of the current leaf, and any new range created because of this leaf MUST contain this leaf URI since a range must include leafs or canvases to make it a range. .  
		        "resources" : [],
		        "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
			};
			if(entryValue !== "" && entryValue !== undefined ){
				var newAnnoURI = "http://www.example.org/iiif/LlangBrev/annos/" +annoID; 
				var newRangeURI = "http://www.example.org/iiif/LlangBrev/range/" +rangeID;
				console.log("Anno Object @ID is being set to :" + newAnnoURI)
				annotationObject["@id"] = newAnnoURI;
				annotationObject.resource["cnt:chars"] = entryValue;
				rangeObject["@id"] = newRangeURI;
				rangeObject.label = entryValue;
				//console.log(annotationObject);

				switch(entryID){
					case "contentAuthor":
						addedInfoList.append("<li><span class='formLabel'>Text Author(s): </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contentLanguage":
						addedInfoList.append("<li><span class='formLabel'>Text Language: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contentTitle":
						addedInfoList.append("<li><span class='formLabel'>Text Title: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contentSection":
						addedInfoList.append("<li><span class='formLabel'>Content Section: </span>"+entryValue+"</li>");
						var updateOrNew = "";
						var rangeToUpdate = "";
						for(var i=1; i<testManifest.structures.length; i++){
							if (testManifest.structures[i].label === entryValue){
								updateOrNew = "update";
								rangeToUpdate = testManifest.structures[i]["@id"];
								updateRange(rangeToUpdate, currentLeaf);
								return false;
							}
							else{
								updateOrNew = "new";
							}
						}
						if(updateOrNew === "new"){
							createNewRange(rangeObject);
						}
						break;
					case "contentSubject":
						addedInfoList.append("<li><span class='formLabel'>Subject: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contentDescription":
						//This could be a range
						addedInfoList.append("<li><span class='formLabel'>Text Description: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contentOther":
						addedInfoList.append("<li><span class='formLabel'>Other Text Information: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "incipit":
						addedInfoList.append("<li><span class='formLabel'>Incipit: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "explicit":
						addedInfoList.append("<li><span class='formLabel'>Explicit: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "rubrics":
						addedInfoList.append("<li><span class='formLabel'>Rubrics: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "chant":
						addedInfoList.append("<li><span class='formLabel'>Chant: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "gloss":
						addedInfoList.append("<li><span class='formLabel'>Gloss: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "marginalAnnos":
						addedInfoList.append("<li><span class='formLabel'>Marginal Annos: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "interlinearAnnos":
						addedInfoList.append("<li><span class='formLabel'>Interlinear Annos: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contentRelated":
						addedInfoList.append("<li><span class='formLabel'>Content Related: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;

					default:
				}
			}
		});

		$(".contextFormEntry").each(function(){
			var annotationObject = {
			"@id" : "",
	        "@type" : "oa:Annotation",
	        "motivation" : "sc:painting",
	        "label" : "",
	        "resource" : {
	          "@type" : "cnt:ContentAsText",
	          "cnt:chars" :""
			},
			"on" : canvasURI //this will be a rangeURI if uriToSave is set to the leaf uri instead of a canvasURI, which is what we want.  annotations can be saved to ranges. 
			};
			var rangeObject = { //this will only be saved 
				"@id" : "",
		        "@type" : "sc:Range",
		        "motivation" : "sc:painting",
		        "label" : "",
		        "canvases": [],
		        "ranges" : [currentLeaf], //This is always the URI of the current leaf, and any new range created because of this leaf MUST contain this leaf URI since a range must include leafs or canvases to make it a range. .  
		        "resources" : [],
		        "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
			};
			var addedInfoList = {};
			if(zeta){ addedInfoList = $("#zetaInformation").find(".contextList"); }
			else if(alpha){ addedInfoList = $("#alphaInformation").find(".contextList"); }
			else if(beta){ addedInfoList = $("#betaInformation").find(".contextList"); }
			var entryID = $(this).attr("id");
			var entryValue = $(this).val();
			if(entryValue !== "" && entryValue !== undefined ){
				var newAnnoURI = "http://www.example.org/iiif/LlangBrev/annos/" +annoID; 
				var newRangeURI = "http://www.example.org/iiif/LlangBrev/range/" +rangeID;
				annotationObject["@id"] = newAnnoURI;
				annotationObject.resource["cnt:chars"] = entryValue;
				rangeObject["@id"] = newRangeURI;
				rangeObject.label = entryValue;
				switch(entryID){
					case "previousOwners":
						addedInfoList.append("<li><span class='formLabel'>Previous Owner(s): </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "nickname":
						addedInfoList.append("<li><span class='formLabel'>Nickname: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contextPatron":
						addedInfoList.append("<li><span class='formLabel'>Patron: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
    					break;
					case "insignia":
						addedInfoList.append("<li><span class='formLabel'>Insignia: </span>"+entryValue+"</li>");
						createNewAnno(annotationObject);
						break;
					case "exlibris":
						addedInfoList.append("<li><span class='formLabel'>Exlibris: </span>"+entryValue+"</li>");
						createNewAnno(annotationObject);
						break;
					case "binding":
						addedInfoList.append("<li><span class='formLabel'>Binding: </span>"+entryValue+"</li>");
						createNewAnno(annotationObject);
						break;
					case "frame":
						addedInfoList.append("<li><span class='formLabel'>Frame: </span>"+entryValue+"</li>");
						createNewAnno(annotationObject);
						break;
					case "contextSection":
						addedInfoList.append("<li><span class='formLabel'>Section: </span>"+entryValue+"</li>");
						var updateOrNew = "";
						var rangeToUpdate = "";
						var leafToAdd = "";
						for(var i=1; i<testManifest.structures.length; i++){
							if (testManifest.structures[i].label === entryValue){
								updateOrNew = "update";
								rangeToUpdate = testManifest.structures[i]["@id"];
								updateRange(rangeToUpdate, currentLeaf);
								return false;
							}
							else{
								updateOrNew = "new";
							}
						}
						if(updateOrNew === "new"){
							createNewRange(rangeObject);
						}
						break;
					case "contextAuction":
						addedInfoList.append("<li><span class='formLabel'>Recent Auctions: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contextDateAcquired":
						addedInfoList.append("<li><span class='formLabel'>Date Acquired: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "contextFolioID":
						addedInfoList.append("<li><span class='formLabel'>Shelfmark: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					// case "contextRelated":
					// 	addedInfoList.append("<li><span class='formLabel'>Shelfmark: </span>"+entryValue+"</li>");
    	// 				createNewAnno(annotationObject);
					// 	break;
					case "contextOther":
						addedInfoList.append("<li><span class='formLabel'>Other Context Information: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					default:
				}	
			}		
		});

		$(".carrierFormEntry").each(function(){
			var annotationObject = {
				"@id" : "",
		        "@type" : "oa:Annotation",
		        "motivation" : "sc:painting",
		        "label" : "",
		        "resource" : {
		          "@type" : "cnt:ContentAsText",
		          "cnt:chars" :""
				},
				"on" : canvasURI //this will be a rangeURI if uriToSave is set to the leaf uri instead of a canvasURI, which is what we want.  annotations can be saved to ranges. 
			};
			var rangeObject = { //this will only be saved 
				"@id" : "",
		        "@type" : "sc:Range",
		        "motivation" : "sc:painting",
		        "label" : "",
		        "canvases": [],
		        "ranges" : [currentLeaf], //This is always the URI of the current leaf, and any new range created because of this leaf MUST contain this leaf URI since a range must include leafs or canvases to make it a range. .  
		        "resources" : [],
		        "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
			};
			var addedInfoList = {};
			if(zeta){ addedInfoList = $("#zetaInformation").find(".carrierList"); }
			else if(alpha){ addedInfoList = $("#alphaInformation").find(".carrierList"); }
			else if(beta){ addedInfoList = $("#betaInformation").find(".carrierList"); }
			var entryID = $(this).attr("id");
			var entryValue = $(this).val();
			if(entryValue !== "" && entryValue !== undefined ){
				var newAnnoURI = "http://www.example.org/iiif/LlangBrev/annos/" +annoID; 
				var newRangeURI = "http://www.example.org/iiif/LlangBrev/range/" +rangeID;
				annotationObject["@id"] = newAnnoURI;
				annotationObject.resource["cnt:chars"] = entryValue;
				rangeObject["@id"] = newRangeURI;
				rangeObject.label = entryValue;
				switch(entryID){
					case "pageWidth":
						addedInfoList.append("<li><span class='formLabel'>Page Width: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "pageHeight":
						addedInfoList.append("<li><span class='formLabel'>Page Height </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "condition":
						addedInfoList.append("<li><span class='formLabel'>Condition: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierLayout":
						addedInfoList.append("<li><span class='formLabel'>Condition: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierRulings":
						addedInfoList.append("<li><span class='formLabel'>Rulings: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierPrickings":
						addedInfoList.append("<li><span class='formLabel'>Rulings: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierScript":
						addedInfoList.append("<li><span class='formLabel'>Script: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "musicNotation":
						addedInfoList.append("<li><span class='formLabel'>Music Notation: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "scribe":
						addedInfoList.append("<li><span class='formLabel'>Scribe: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierRV":
						addedInfoList.append("<li><span class='formLabel'>Recto or Verso: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierOrigin":
						addedInfoList.append("<li><span class='formLabel'>Origin: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierDecorations":
						addedInfoList.append("<li><span class='formLabel'>Decorations: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "support":
						addedInfoList.append("<li><span class='formLabel'>Support: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "catchWords":
						addedInfoList.append("<li><span class='formLabel'>Catch Words: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierSignatures":
						addedInfoList.append("<li><span class='formLabel'>Signature(s): </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierFolioNum":
						addedInfoList.append("<li><span class='formLabel'>FolioNum: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierRelated":
						addedInfoList.append("<li><span class='formLabel'>Carrier Related: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierPageNum":
					//This one is special because it tries to place the leaf directly into the master range.  I think we should add it into the master range when this is defined AND attach this information as an annotation.
						addedInfoList.append("<li><span class='formLabel'>Page Number: </span>"+entryValue+"</li>");
						var masterRange = testManifest.structures[0];
						//we have the current leaf ID up top to have for API.
						if(masterRange.ranges[entryValue - 1] === undefined || masterRange.ranges[entryValue - 1] === {}){
							//This slot is not occupied.  Add the leaf object without worry
							//Check every spot before it.  If it is empty, place an empty object so that the index up to this point can be defined.  If it isn't empty, then the index is intact for this part so ignore it.
							for(var i=0; i<entryValue-1; i++){
								if(masterRange.ranges[i] === undefined){
									masterRange.ranges[i] = {};
								}
							}
							masterRange.ranges[entryValue - 1] = currentLeafObject;
						}
						else{
							//We have created a conflict.  I am trying to place a leaf in the master range at a location tht already has a leaf.  How will we handle this?
							alert("CONFLICT.  WE NEED TO FIGURE THIS PART OUT.")
						}
						break;
					case "carrierFormat":
						addedInfoList.append("<li><span class='formLabel'>Carrier Format: </span>"+entryValue+"</li>");
						var updateOrNew = "";
						var rangeToUpdate = "";
						var leafToAdd = "";
						for(var i=1; i<testManifest.structures.length; i++){
							if (testManifest.structures[i].label === entryValue){
								updateOrNew = "update";
								rangeToUpdate = testManifest.structures[i]["@id"];
								updateRange(rangeToUpdate, currentLeaf);
								return false;
							}
							else{
								updateOrNew = "new";
							}
						}
						if(updateOrNew === "new"){
							createNewRange(rangeObject);
						}
						break;
					case "carrierIllustrations":
						addedInfoList.append("<li><span class='formLabel'>Illustrations: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierArtists":
						addedInfoList.append("<li><span class='formLabel'>Carrier Artist(s): </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierDate":
						addedInfoList.append("<li><span class='formLabel'>Carrier Date: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					case "carrierOther":
						addedInfoList.append("<li><span class='formLabel'>Other Carrier Information: </span>"+entryValue+"</li>");
    					createNewAnno(annotationObject);
						break;
					default:
				}	
			}	
		});

		//Grab the additional notes field and save it as an annotation
		var otherInfoList = {};
		if(zeta){otherInfoList = $("#zetaInformation").find(".addedNotes"); }
		else if(alpha){otherInfoList = $("#alphaInformation").find(".addedNotes"); }
		else if(beta){otherInfoList = $("#betaInformation").find(".addedNotes"); }
		var canvasNotes = $("#notes").val();
		if(canvasNotes !== ""){
			var newAnnoURI = "http://www.example.org/iiif/LlangBrev/annos/" +annoID; 
			var canvasURI = $("#catalogueInfoFor").val();
			otherInfoList.append("<li><span class='formLabel'>General Notes: </span>"+canvasNotes+"</li>");
			var annoObject = {
				"@id" : newAnnoURI,
		        "@type" : "oa:Annotation",
		        "motivation" : "sc:painting",
		        "label" : "General Metadata",
		        "resource" : {
		          "@type" : "cnt:ContentAsText",
		          "cnt:chars" : canvasNotes
				},
				"on" : canvasURI
			};
			createNewAnno(annoObject);
		}

		$(".start").hide("blind", "300ms", function(){
			$(".imgAdditionArea").show("explode", "500ms");
			$("#catalogueInfoFor").val(''); 
			$("#folioSide2").removeClass("selectedFolio");
			$("#folioSide1").removeClass("selectedFolio");
		});

		//since we are saving and going back to choosing what to give additional information to, all the possible choices are set to false to be chosen from again. 
		alpha = beta = zeta = false;

	}

	/*
		This function takes the annotation object and saves it in the manifest object in the appropriate location.  it makes the decision whether the annotation is being saved to a canvas or a range. 
	*/

	function createNewAnno(annoObject){
		annoID ++;

		var objectID = $("#catalogueInfoFor").val(); //which object are we saving to
		if(zeta){ //we are saving to a leaf range, so we have to go through STRUCTURES and find it.  You can also check if objectID contains "/range"
			$.each(testManifest.structures, function(){
				if (this["@id"] === objectID){ //Then this is our structure
					this.resources.push(annoObject); //push the annotation object to its resources.
					//I have the object to pass.  Do I need to pass as parameters instead of the object? Will this also save an annotation?
					// var newAnnoUrl = "http://localhost:8080/brokenBooks/saveNewRangeServlet";
					// var params = annoObject;
					// $.post(newAnnoUrl, params);
				}
			});
		}
		else{ // we are saving to a canvas so we have to go through the SEQUENCE and find it.  You can also check if objectID contains "/canvas"
			$.each(testManifest.sequences[0].canvases, function(){
				if (this["@id"] === objectID){ //this is our canvas object
					this.resources.push(annoObject); //push the annotation to the canvas object.
					//Will this also save an annotation?
					// var newAnnoUrl = "http://localhost:8080/brokenBooks/saveNewRangeServlet";
					// var params = annoObject;
					// $.post(newAnnoUrl, params);
				}
			});
		}
	}

	/*
		Add the range object to the structures array in the manifest object. 
	*/
	function createNewRange(newRangeObject){
		rangeID ++;
		//create a new range, given that some new information organizes canvases into a new range.  We will need to make sure the range does not already exist. 
		testManifest.structures.push(newRangeObject);
		// var newAnnoUrl = "http://localhost:8080/brokenBooks/saveNewRangeServlet";
		// var params = annoObject;
		// $.post(newAnnoUrl, params);
		
	}
	/*
		This range is already in the manifest structures section, so what we are actually trying to do is save this leaf to the already created range.  We must check whether the leaf URI is already in the "ranges" section of the range.  There should be no duplicate URIs. 
	*/
	function updateRange(rangeID, leaf){
		console.log("Updating range "+rangeID+" with leaf "+leaf);
		var currentRange = {};
		$.each(testManifest.structures, function(){
			if(this["@id"] === rangeID){
				if(!$.inArray(leaf, $(this).ranges)){
					console.log("pushing leaf to range")
					this.ranges.push(leaf);
					// var newAnnoUrl = "http://localhost:8080/brokenBooks/saveNewRangeServlet";
					// var params = annoObject;
					// $.post(newAnnoUrl, params);
				}
				else{
					console.log('LEAF already in range.')
				}
				return false;
			}
		});
	}
	
	function resloveImageURI(rv){
		var uri = $("."+rv+"Canvas").find(".uploadness").find('textarea').val();
	    $.ajax({
	        url: uri,
	        success: function(imageData){
	            console.log(imageData);
	        },
	        error: function(jqXHR,error, errorThrown) {  
	            alert("Image could not be resolved.  Issue: " +  jqXHR.status + " - " +jqXHR.response);
	        }
	    });
	}

	/*
		Dont save the fields and return to the image options.  
	*/

	function cancelFolio(){
		//Don't get data and return to image page
		$(".start").hide("blind", "300ms", function(){
			$(".imgAdditionArea").show("explode", "500ms");
			$("#catalogueInfoFor").val(''); 
			$("#folioSide2").removeClass("selectedFolio");
			$("#folioSide1").removeClass("selectedFolio");
			alpha = beta = zeta = false;
		});
	}

	/*
		Fired when user clicks "Begin preparing a leaf".  We must create the canvases and the leaf range first, then feed it information as necessary. 
	*/
	function submitIntro(){
		$(".intro").hide("blind", "300ms", function(){$(".imgAdditionArea").show("explode", "500ms");});
		//create a new leaf range and get ID.  The leaf range will create 2 canvases whose ID's I will also need.
		canvasID += 1;
		var newCanvas1 = {
	        "@id" : "http://www.example.org/iiif/LlangBrev/canvases/"+canvasID,
	        "@type" : "sc:Canvas",
	        "label" : "Llang_"+canvasID,
	        "height" : 1000,
	        "width" : 667,
	        "resources" : [ 
        	]
      	 }
      	 $("#versoCatalogue").attr("onclick","enterCatalogueInfo('http://www.example.org/iiif/LlangBrev/canvases/"+canvasID+"', 'verso');");
      	 $("input[rv='verso']").attr("canvas","http://www.example.org/iiif/LlangBrev/canvases/"+canvasID);
      	 testManifest.sequences[0].canvases.push(newCanvas1);
      	 canvasID += 1;
      	 var newCanvas2 = {
	        "@id" : "http://www.example.org/iiif/LlangBrev/canvases/"+canvasID,
	        "@type" : "sc:Canvas",
	        "label" : "Llang_"+canvasID,
	        "height" : 1000,
	        "width" : 667,
	        "resources" : [ 
        	]
      	 }
      	 $("#rectoCatalogue").attr("onclick","enterCatalogueInfo('http://www.example.org/iiif/LlangBrev/canvases/"+canvasID+"','recto');");
      	 $("input[rv='recto']").attr("canvas","http://www.example.org/iiif/LlangBrev/canvases/"+canvasID);
      	 testManifest.sequences[0].canvases.push(newCanvas2);
      	 leafRange += 1;
		 var leafRange = {
 		  "@id":"http://www.example.org/iiif/LlangBrev/range/"+rangeID,
	      "@type":"sc:Range",
	      "label":"Llangantock Breviary Page_"+rangeID ,
	      "canvases" : [
	          newCanvas1["@id"],
	          newCanvas2["@id"]
	      ],
	      "resources" : [],
	      "ranges" : [],
	      "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
		}
		currentLeaf = leafRange["@id"];
		createNewRange(leafRange);
	}

	/*
		Fires when user clicks to enter additional information.  This mainly changes the UI to highlight which part of the leaf the user is working on and show them the information field in the left column.  
	*/
	function enterCatalogueInfo(canvasID, canvas){
		var previewImgSrc = $("."+canvas+"Img").attr("src");
		$(".imgPreview").attr("src",previewImgSrc);
		$(".contentFormEntry").val("");
		$(".contextFormEntry").val("");
		$(".carrierFormEntry").val("");
		$(".imgAdditionArea").hide("blind", "300ms", function(){
			$(".start").show("explode", "500ms");
			if(canvas === 'recto'){
				$("#folioSide1").addClass("selectedFolio");
				$("#folioSide2").removeClass("selectedFolio");
				$("#catalogueInfoFor").val(canvasID); //alpha
				alpha = true;
			}
			else if (canvas === 'verso'){
				$("#folioSide2").addClass("selectedFolio");;
				$("#folioSide1").removeClass("selectedFolio");
				$("#catalogueInfoFor").val(canvasID); //beta
				beta = true;
			}
			else{
				$("#folioSide2").addClass("selectedFolio");
				$("#folioSide1").addClass("selectedFolio");
				$("#catalogueInfoFor").val(currentLeaf); //zeta
				alpha = beta = true;
			}
			if(alpha && beta) zeta = true;

			if(zeta){
				$("#zetaInformation").show("explode" , "500ms");
			}
			else if (alpha){
				$("#alphaInformation").show("explode" , "500ms");
			}
			else if (beta){
				$("#betaInformation").show("explode" , "500ms");
			}
			else{
				//this means there is an error
				console.log('ALPHA-BETA-ZETA ERROR');
				alpha = beta = zeta = false;
			}
			// $("#start").attr("onclick", "submitStart('"+canvas+"');");
		});
		
	}

	/*
		Accordion UI
	*/
	$(function(){
		$(".leaf").load("../brokenBooks/leafTemplate.html"); 
		$("#formAccordion").accordion({
			active:false,
			collapsible: true,
			heightStyle: "content"
		});

	});
		
</script>
