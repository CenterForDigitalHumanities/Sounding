<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Current Manifest</title>
        <meta charset="UTF-8">
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.js"></script>
        <link rel="stylesheet" href="../brokenBooks/css/brokenbooks.css">
        <style>
            .range{
                border: 2px solid red;
                margin: 5px;
                display: block;
                position: relative;
            }
            .range .range{
                border: 2px solid purple;
            }

            .range .range .range{
                border: 2px solid orange;
            }
            .range .range .range .range{
                border: 2px solid green;
            }
            .canvas{
                border: 2px solid blue;
                display: inline-block;
                position: relative;
            }

            .canvasImg{
              max-height: 300px;
              max-width: 200px;
            }
        </style>
    </head>
    <body>
        <div class="mainBlock" id="focusedRange">
            <button onclick="organizeRanges();">SORT RANGES</button>
        </div>
        <div class="sideBarInfo">
            <div class="manifestData"></div>
            <div id="manifestRanges"></div>
        </div>
    </body>
</html>
<script>
var rangeCollection = [
{
  "@id":"http://www.example.org/iiif/LlangBrev/range/1",
  "@type":"sc:Range",
  "label":"Page 1",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://i.huffpost.com/gen/1719761/images/o-COOL-CAT-facebook.jpg", "http://cloud-4.steamusercontent.com/ugc/43108316458046990/EC4110525593F4CC213E69257ABE6F0BE1D18D9A/"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/2",
  "@type":"sc:Range",
  "label":"Page 2",
  "ranges" : [
  ],
  "canvases" :["http://www.yoyowall.com/wp-content/uploads/2013/03/Abstract-Colourful-Cool.jpg", "http://t1.gstatic.com/images?q=tbn:ANd9GcTp4NWeyeVT9SAmrOTmjyR1x_WQIUsIxs-LuWTBF8ywgB0V1dkM"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/3",
  "@type":"sc:Range",
  "label":"Page 3",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://funlava.com/wp-content/uploads/2013/03/cool-hd-wallpapers.jpg", "http://homenewdepot.co/assets/Oi8vdaW5wa3d3LnBob3RvaW5waXhlbC5jb20=/18074/mypicture/nice-cool-gundam-hd-desktop-wallpaper-backgrounds.jpg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/4",
  "@type":"sc:Range",
  "label":"Page 4",
  "ranges" : [
  ],
  "canvases" :["http://www.hdwallpaperscool.com/wp-content/uploads/2014/06/amazing-backgrounds-cool-wallpapers-of-high-resolution.jpg", "http://t3.gstatic.com/images?q=tbn:ANd9GcR-CUW-EqZ7WboySAFm_3oQH9xLbxZsSHu2EyPsQ8gCObts0-nJ"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/5",
  "@type":"sc:Range",
  "label":"Page 5",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://t1.gstatic.com/images?q=tbn:ANd9GcQM3TBh35_znmOW65GdTY1u6WZCa5smnvv_s1nIJl355iaqIBeVGg", "http://www.darveshtv.com/wp-content/uploads/2015/02/cool_car_3d_wallpapers_hot.jpg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/6",
  "@type":"sc:Range",
  "label":"Page 6: What do you think?",
  "ranges" : [
  ],
  "canvases" :["http://ajournalofmusicalthings.com/wp-content/uploads/Cool.jpg", "http://upload.wikimedia.org/wikipedia/commons/2/20/Cool,_Calif_sign.jpg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/102",
  "@type":"sc:Range",
  "label":"First Page, Last Secion",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://t1.gstatic.com/images?q=tbn:ANd9GcT_cVgwB1vOupPsjjiGbnPrkK24fpq9BThi3fkVNrgoX0oMNwzv0w", "http://t0.gstatic.com/images?q=tbn:ANd9GcTLM1VY3Ehp3F1hd78mrszS3euO32XV-BjtgXaaKNcRJ8je3ECmZg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},
{
  "@id":"http://www.example.org/iiif/LlangBrev/range/103",
  "@type":"sc:Range",
  "label":"Last Page, Last Secion",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://browsewallpaper.com/wp-content/uploads/2014/11/cool%20designs%20wallpaper-cKAa.jpg","http://www.desktopaper.com/wp-content/uploads/great-cool-design-backgrounds.jpg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/104",
  "@type":"sc:Range",
  "label":"Unknown Page X, Last Secion",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://upload.wikimedia.org/wikipedia/commons/thumb/b/b9/Haliaeetus_leucocephalus_-Skagit_valley-8-2c.jpg/300px-Haliaeetus_leucocephalus_-Skagit_valley-8-2c.jpg","http://www.chicagonow.com/greenamajigger/files/2013/04/bee-eater_1627477i.jpg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/105",
  "@type":"sc:Range",
  "label":"Unknown Page Y, Last Secion",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://www.arizonafoothillsmagazine.com/images/stories/aug13/Butterfly_Blue.jpg", "http://upload.wikimedia.org/wikipedia/commons/thumb/4/4b/Butterflies_%28Costa_Rica%29.jpg/800px-Butterflies_%28Costa_Rica%29.jpg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/106",
  "@type":"sc:Range",
  "label":"Last Section",
  "ranges" : [
     "http://www.example.org/iiif/LlangBrev/range/102",
     "http://www.example.org/iiif/LlangBrev/range/103",
     "http://www.example.org/iiif/LlangBrev/range/105",
     "http://www.example.org/iiif/LlangBrev/range/104",
   ],
  "canvases" :[],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
}, //EX: we know this is the last section.  Here are 4 pages we know are in it.  It is not inside the table of contents array.

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/7",
  "@type":"sc:Range",
  "label":"Section 1",
  "ranges" : ["http://www.example.org/iiif/LlangBrev/range/1", "http://www.example.org/iiif/LlangBrev/range/2"],
  "canvases" :[],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/8",
  "@type":"sc:Range",
  "label":"Section 2",
  "ranges" : ["http://www.example.org/iiif/LlangBrev/range/3", "http://www.example.org/iiif/LlangBrev/range/4"],
  "canvases" :[],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/9",
  "@type":"sc:Range",
  "label":"Section 3",
  "ranges" : ["http://www.example.org/iiif/LlangBrev/range/5", "http://www.example.org/iiif/LlangBrev/range/6"],
  "canvases" :[],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/10",
  "@type":"sc:Range",
  "label":"Table Of Contents",
  "ranges" : ["http://www.example.org/iiif/LlangBrev/range/7", "http://www.example.org/iiif/LlangBrev/range/8", "http://www.example.org/iiif/LlangBrev/range/9"],
  "canvases" :[],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

{
  "@id":"http://www.example.org/iiif/LlangBrev/range/110",
  "@type":"sc:Range",
  "label":"canterberry page, unknown section",
  "ranges" : [
      //add leaf ranges here in order for page order
  ],
  "canvases" :["http://www.slu.edu/Images/marketing_communications/logos/slu/slu_2c.bmp", "http://vaccinenewsdaily.com/wp-content/uploads/2015/01/SLU_Vert_blue.jpg"],
  "isPartOf": "http://www.example.org/iiif/LlangBrev/sequence/normal"
},

]

function getAllRanges(){
    return rangeCollection;
}

/*
* @params: rangeCollection: an array containing all the ranges of a project.  It is sorted so the array contains ranges from smallest to largest. 
*For now, it is a global array.  It will most likely be handed in as a parameter to the function in the future. 
*Builds the tree structure of ranges from an ordered list of ranges (by size of their ranges[] field).
*/
function organizeRanges(){
    rangeCollection = mergeSort(rangeCollection);
    var existingRanges = [];
    for(var i = rangeCollection.length - 1; i>=0; i--){
        var outerRange = rangeCollection[i]; //We have to look at each range, so at some point each range is the outer range...
        // console.log("RANGE");
        // console.log(rangeCollection[i])
        var outerRangeLabel = rangeCollection[i].label;
        //existingRanges.push(rangeCollection[i]["@id"]);
        var existingRangeToUpdate = "";
        //...The trick is that we check if we have already accounted for this range as an outer range
        if($("#focusedRange").find('div[rangeID="'+rangeCollection[i]['@id']+'"]').length > 0){ 
          //If so, then what we are doing is adding other sections or leaves into it, so there is an existing range. 
          existingRangeToUpdate = $("#focusedRange").find('div[rangeID="'+rangeCollection[i]['@id']+'"]'); // get it.
        }

        //Create an html range object that can be added
        var currentRange = $("<div class='range' rangeID='"+rangeCollection[i]["@id"]+"'><div>"+outerRangeLabel+"</div></div>");
        //Collect the inner ranges for this range.  It will be an array(0) if there are none. 
        var innerRanges = rangeCollection[i].ranges;
        //obvious
        if(innerRanges.length > 0){ //If there are inner ranges
            for(var j = 0; j<innerRanges.length;j++){ //go over each inner range
                var thisRange = innerRanges[j];
                $.each(rangeCollection, function(){ //check each range in the collection
                    if(this["@id"] === thisRange){ //find the object by ID among the collection.  When you find it, gets its information.
                        var thisLabel = this.label;
                        var embedRange = $("<div class='range' rangeID='"+this['@id']+"'><div>"+thisLabel+"</div></div>"); //Create an html range object for the inner range.
                        if(existingRangeToUpdate !== ""){ // If it is an existing range, then embed this range in the existing range.
                          existingRangeToUpdate.append(embedRange);
                        }
                        else{ //otherwise, it is a new range that this embedded range goes into.  Embed it, then add the parent/child structure to the DOM. 
                          currentRange.append(embedRange);
                          $("#focusedRange").append(currentRange);
                        }
                    } //If you didn't find it among the collection, we can't do anything with it.  
                });
            }
        }
        else{ //There are no inner ranges, so we must be on a leaf.  It MAY or MAY NOT contain an image or annotation, so account for finding none. 
            var currentCanvases = outerRange.canvases; //For testing purposes, I just put a URL in for the canvas.  What we would really do is get canvas info via the URI and build a canvas inside the leaf range.  This skips a step and just grabs this random image URI I went on google and found. 
            console.log("CANVASES");
            console.log(currentCanvases);
            var rangeForCanvases = $("#focusedRange").find('div[rangeID="'+outerRange['@id']+'"]');
            $.each(currentCanvases, function(){ //for whatever canvases there are, if any
                // $.each(rangeCollection, function(){
                //     if(this["@id"] === currentCanvas){
                //         //This is the canvas to get data from
                //     }
                // });
                var currentCanvas = $("<div class='canvas'><img class='canvasImg' src='"+this+"'/></div>"); //create an html canvas object
                if(rangeForCanvases){ //if the range exists in a section
                  rangeForCanvases.append(currentCanvas); //put the canvas object in the range object (the leaf)
                }
                else{ //the range does not exist in a section, but rather as a parent range.  Append to DOM.
                  $("#focusedRange").append(currentCanvas)
                }
            });
        }
        
    }
}

/*
* Helper function for mergeSort().  It mergest the left and right arrays created when splitting the source array in the middle. 
*/
function merge(left, right){
    var result  = [],
        il      = 0,
        ir      = 0;

    while (il < left.length && ir < right.length){
        if (left[il].ranges.length < right[ir].ranges.length){
            result.push(left[il++]);
        } else {
            result.push(right[ir++]);
        }
    }

    return result.concat(left.slice(il)).concat(right.slice(ir));
}
/*
* The classic merge sort function that sorts an array of numbers from smallest to largest.  In our case, the array is an array of range objects, but what I test is the length of their ranges[] field, since those with the highest count in the ranges[] field will be top parent objects and the ordered array is easier to build the tree structure from.  Even for an array of 1000 ranges, this runs pretty quick.  
*/
function mergeSort(items){
    if (items.length < 2) {
        return items;
    }

    var middle = Math.floor(items.length / 2),
        left    = items.slice(0, middle),
        right   = items.slice(middle),
        params = merge(mergeSort(left), mergeSort(right));
    
    // Add the arguments to replace everything between 0 and last item in the array
    params.unshift(0, items.length);
    items.splice.apply(items, params);
    return items;
}
</script>